stages:
  - build
  - deploy

variables:
  # Container Registry TimeWeb
  REGISTRY_URL: "${CI_REGISTRY_URL:-registry.timeweb.cloud}"
  REGISTRY_IMAGE_PREFIX: "${CI_REGISTRY_IMAGE_PREFIX:-archpad}"
  
  # Docker build settings
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Шаблон для сборки Docker образа
.build_docker_image:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - export COMMIT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - 'echo "Building for commit $COMMIT_SHA"'
    - |
      if [ -z "$REGISTRY_USERNAME" ] || [ -z "$REGISTRY_PASSWORD" ]; then
        echo "ERROR: REGISTRY_USERNAME and REGISTRY_PASSWORD must be set in GitLab CI/CD Variables"
        exit 1
      fi
    - docker login -u "$REGISTRY_USERNAME" -p "$REGISTRY_PASSWORD" "$REGISTRY_URL"
  script:
    - export SERVICE_NAME="${CI_JOB_NAME#build:}"
    - export IMAGE_TAG="${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/${SERVICE_NAME}:${COMMIT_SHA}"
    - export IMAGE_TAG_LATEST="${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/${SERVICE_NAME}:latest"
    - 'echo "Building $SERVICE_NAME (commit $COMMIT_SHA)"'
    - docker build -t "$IMAGE_TAG" -t "$IMAGE_TAG_LATEST" -f "$DOCKERFILE_PATH" "$BUILD_CONTEXT"
    - docker push "$IMAGE_TAG"
    - docker push "$IMAGE_TAG_LATEST"
    - 'echo "✅ Image pushed: $IMAGE_TAG"'
  after_script:
    - docker logout "$REGISTRY_URL" || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ============================================
# Backend Services
# ============================================

build:arch-repo-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/arch-repo-service/Dockerfile"
    BUILD_CONTEXT: "."

build:tenant-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/tenant-service/Dockerfile"
    BUILD_CONTEXT: "."

build:hasura-sync-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/hasura-sync-service/Dockerfile"
    BUILD_CONTEXT: "."

# ============================================
# Frontend
# ============================================

build:portal:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/portal/Dockerfile"
    BUILD_CONTEXT: "."

# ============================================
# Deploy (опционально, для автоматического обновления образов в Kubernetes)
# ============================================

# Примечание: Для автоматического обновления образов в Kubernetes можно использовать:
# 1. ArgoCD Image Updater (рекомендуется)
# 2. Или обновлять манифесты через kubectl в этом stage

deploy:update-images:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - export COMMIT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - 'echo "Images built successfully"'
    - 'echo "- arch-repo-service ${COMMIT_SHA}"'
    - 'echo "- tenant-service ${COMMIT_SHA}"'
    - 'echo "- hasura-sync-service ${COMMIT_SHA}"'
    - 'echo "- portal ${COMMIT_SHA}"'
    - echo ""
    - 'echo "To update images in Kubernetes, use ArgoCD Image Updater or update manifests manually"'
    - 'echo "Example: kubectl set image deployment/arch-repo-service arch-repo-service=${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/arch-repo-service:${COMMIT_SHA} -n platform"'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
