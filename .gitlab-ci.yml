stages:
  - build
  - deploy

variables:
  # Container Registry TimeWeb
  REGISTRY_URL: "${CI_REGISTRY_URL:-archpad-cr.registry.twcstorage.ru}"
  REGISTRY_IMAGE_PREFIX: "${CI_REGISTRY_IMAGE_PREFIX:-archpad}"
  
  # Docker build settings
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Шаблон для сборки Docker образа
.build_docker_image:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - export COMMIT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - 'echo "Building for commit $COMMIT_SHA"'
    - 'echo "Registry URL: $REGISTRY_URL"'
    - |
      if [ -z "$REGISTRY_USERNAME" ] || [ -z "$REGISTRY_PASSWORD" ]; then
        echo "=========================================="
        echo "ERROR: Missing required CI/CD Variables"
        echo "=========================================="
        echo "Please set the following variables in GitLab:"
        echo "  Settings → CI/CD → Variables → Expand"
        echo ""
        echo "Required variables:"
        [ -z "$REGISTRY_USERNAME" ] && echo "  ❌ REGISTRY_USERNAME (not set)" || echo "  ✅ REGISTRY_USERNAME (set)"
        [ -z "$REGISTRY_PASSWORD" ] && echo "  ❌ REGISTRY_PASSWORD (not set)" || echo "  ✅ REGISTRY_PASSWORD (set)"
        echo ""
        echo "How to set:"
        echo "  1. Go to: Settings → CI/CD → Variables"
        echo "  2. Click 'Add variable'"
        echo "  3. Set Key: REGISTRY_USERNAME, Value: your-registry-username"
        echo "  4. Set Key: REGISTRY_PASSWORD, Value: your-registry-password (masked)"
        echo "  5. Save and retry the pipeline"
        echo "=========================================="
        exit 1
      fi
    - |
      if [ -z "$REGISTRY_URL" ]; then
        echo "ERROR: REGISTRY_URL is not set, defaulting to archpad-cr.registry.twcstorage.ru"
        export REGISTRY_URL="archpad-cr.registry.twcstorage.ru"
      fi
      echo "Logging in to registry: $REGISTRY_URL"
      echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USERNAME" --password-stdin "$REGISTRY_URL"
  script:
    - export SERVICE_NAME="${CI_JOB_NAME#build:}"
    - export IMAGE_TAG="${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/${SERVICE_NAME}:${COMMIT_SHA}"
    - export IMAGE_TAG_LATEST="${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/${SERVICE_NAME}:latest"
    - 'echo "Building $SERVICE_NAME (commit $COMMIT_SHA)"'
    - docker build -t "$IMAGE_TAG" -t "$IMAGE_TAG_LATEST" -f "$DOCKERFILE_PATH" "$BUILD_CONTEXT"
    - docker push "$IMAGE_TAG"
    - docker push "$IMAGE_TAG_LATEST"
    - 'echo "✅ Image pushed: $IMAGE_TAG"'
  after_script:
    - docker logout "$REGISTRY_URL" || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ============================================
# Backend Services
# ============================================

build:arch-repo-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/arch-repo-service/Dockerfile"
    BUILD_CONTEXT: "."

build:tenant-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/tenant-service/Dockerfile"
    BUILD_CONTEXT: "."

build:hasura-sync-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/hasura-sync-service/Dockerfile"
    BUILD_CONTEXT: "."

# ============================================
# Frontend
# ============================================

build:portal:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/portal/Dockerfile"
    BUILD_CONTEXT: "."

# ============================================
# Deploy (опционально, для автоматического обновления образов в Kubernetes)
# ============================================

# Примечание: Для автоматического обновления образов в Kubernetes можно использовать:
# 1. ArgoCD Image Updater (рекомендуется)
# 2. Или обновлять манифесты через kubectl в этом stage

deploy:update-images:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - export COMMIT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - 'echo "Images built successfully"'
    - 'echo "- arch-repo-service ${COMMIT_SHA}"'
    - 'echo "- tenant-service ${COMMIT_SHA}"'
    - 'echo "- hasura-sync-service ${COMMIT_SHA}"'
    - 'echo "- portal ${COMMIT_SHA}"'
    - echo ""
    - 'echo "To update images in Kubernetes, use ArgoCD Image Updater or update manifests manually"'
    - 'echo "Example: kubectl set image deployment/arch-repo-service arch-repo-service=${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/arch-repo-service:${COMMIT_SHA} -n platform"'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
