stages:
  - build
  - deploy

variables:
  # Container Registry TimeWeb
  # REGISTRY_URL –∏ REGISTRY_IMAGE_PREFIX –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ GitLab CI/CD Variables
  # –ï—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
  REGISTRY_URL: "${REGISTRY_URL:-archpad-cr.registry.twcstorage.ru}"
  REGISTRY_IMAGE_PREFIX: "${REGISTRY_IMAGE_PREFIX:-archpad}"
  
  # Docker build settings
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# –®–∞–±–ª–æ–Ω –¥–ª—è —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞
.build_docker_image:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - export COMMIT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ REGISTRY_URL –∏ REGISTRY_IMAGE_PREFIX –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ GitLab CI/CD Variables
    # –û–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã, –Ω–æ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–Ω–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
    - export REGISTRY_URL="${REGISTRY_URL:-archpad-cr.registry.twcstorage.ru}"
    - export REGISTRY_IMAGE_PREFIX="${REGISTRY_IMAGE_PREFIX:-archpad}"
    - 'echo "Building for commit $COMMIT_SHA"'
    - 'echo "Registry URL: $REGISTRY_URL"'
    - 'echo "Registry Image Prefix: $REGISTRY_IMAGE_PREFIX"'
    - |
      if [ -z "$REGISTRY_USERNAME" ] || [ -z "$REGISTRY_PASSWORD" ]; then
        echo "=========================================="
        echo "ERROR: Missing required CI/CD Variables"
        echo "=========================================="
        echo "Please set the following variables in GitLab:"
        echo "  Settings ‚Üí CI/CD ‚Üí Variables ‚Üí Expand"
        echo ""
        echo "Required variables:"
        [ -z "$REGISTRY_USERNAME" ] && echo "  ‚ùå REGISTRY_USERNAME (not set)" || echo "  ‚úÖ REGISTRY_USERNAME (set)"
        [ -z "$REGISTRY_PASSWORD" ] && echo "  ‚ùå REGISTRY_PASSWORD (not set)" || echo "  ‚úÖ REGISTRY_PASSWORD (set)"
        echo ""
        echo "How to set:"
        echo "  1. Go to: Settings ‚Üí CI/CD ‚Üí Variables"
        echo "  2. Click 'Add variable'"
        echo "  3. Set Key: REGISTRY_USERNAME, Value: your-registry-username"
        echo "  4. Set Key: REGISTRY_PASSWORD, Value: your-registry-password (masked)"
        echo "  5. Save and retry the pipeline"
        echo "=========================================="
        exit 1
      fi
    - 'echo "Logging in to registry: $REGISTRY_URL"'
    - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USERNAME" --password-stdin "$REGISTRY_URL"
  script:
    - export SERVICE_NAME="${CI_JOB_NAME#build:}"
    # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (–∏–∑ GitLab Variables –∏–ª–∏ fallback)
    - export REGISTRY_URL="${REGISTRY_URL:-archpad-cr.registry.twcstorage.ru}"
    - export REGISTRY_IMAGE_PREFIX="${REGISTRY_IMAGE_PREFIX:-archpad}"
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–≥–∏ –æ–±—Ä–∞–∑–æ–≤
    - export IMAGE_TAG="${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/${SERVICE_NAME}:${COMMIT_SHA}"
    - export IMAGE_TAG_LATEST="${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/${SERVICE_NAME}:latest"
    - 'echo "Building $SERVICE_NAME (commit $COMMIT_SHA)"'
    - 'echo "Image tag: $IMAGE_TAG"'
    - 'echo "Dockerfile: $DOCKERFILE_PATH"'
    - 'echo "Build context: $BUILD_CONTEXT"'
    - docker build -t "$IMAGE_TAG" -t "$IMAGE_TAG_LATEST" -f "$DOCKERFILE_PATH" "$BUILD_CONTEXT"
    - docker push "$IMAGE_TAG"
    - docker push "$IMAGE_TAG_LATEST"
    - 'echo "‚úÖ Image pushed: $IMAGE_TAG"'
  after_script:
    - docker logout "$REGISTRY_URL" || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ============================================
# Backend Services
# ============================================

build:arch-repo-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/arch-repo-service/Dockerfile"
    BUILD_CONTEXT: "."

build:tenant-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/tenant-service/Dockerfile"
    BUILD_CONTEXT: "."

build:hasura-sync-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/hasura-sync-service/Dockerfile"
    BUILD_CONTEXT: "."

# ============================================
# Frontend
# ============================================

build:portal:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/portal/Dockerfile"
    BUILD_CONTEXT: "."

# ============================================
# Deploy (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π stage)
# ============================================

# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ –≤ Kubernetes –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ ArgoCD Image Updater.
# ArgoCD Image Updater –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã –≤ Container Registry –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç
# –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏. ArgoCD –∑–∞—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è.
# 
# –°–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é: docs/ARGOCD_IMAGE_UPDATER_SETUP.md

deploy:update-images:
  stage: deploy
  image: alpine:latest
  script:
    - export COMMIT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - export REGISTRY_URL="${REGISTRY_URL:-archpad-cr.registry.twcstorage.ru}"
    - export REGISTRY_IMAGE_PREFIX="${REGISTRY_IMAGE_PREFIX:-archpad}"
    - 'echo "‚úÖ Images built and pushed successfully"'
    - 'echo ""'
    - 'echo "Built images:"'
    - 'echo "  - arch-repo-service:${COMMIT_SHA} (latest)"'
    - 'echo "  - tenant-service:${COMMIT_SHA} (latest)"'
    - 'echo "  - hasura-sync-service:${COMMIT_SHA} (latest)"'
    - 'echo "  - portal:${COMMIT_SHA} (latest)"'
    - echo ""
    - 'echo "üì¶ ArgoCD Image Updater will automatically detect new images and update Kubernetes manifests"'
    - 'echo "   See: docs/ARGOCD_IMAGE_UPDATER_SETUP.md for details"'
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
