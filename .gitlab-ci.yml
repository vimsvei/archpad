stages:
  - build
  - deploy

variables:
  # Container Registry TimeWeb
  REGISTRY_URL: "${CI_REGISTRY_URL:-registry.timeweb.cloud}"
  REGISTRY_IMAGE_PREFIX: "${CI_REGISTRY_IMAGE_PREFIX:-archpad}"
  
  # Docker build settings
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Шаблон для сборки Docker образа
.build_docker_image:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - export COMMIT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - echo "Building for commit: $COMMIT_SHA"
    - echo "Registry URL: $REGISTRY_URL"
    - echo "Registry Image Prefix: $REGISTRY_IMAGE_PREFIX"
    - |
      if [ -z "$REGISTRY_USERNAME" ] || [ -z "$REGISTRY_PASSWORD" ]; then
        echo "ERROR: REGISTRY_USERNAME and REGISTRY_PASSWORD must be set in GitLab CI/CD Variables"
        exit 1
      fi
    - echo "Logging in to container registry..."
    - docker login -u "$REGISTRY_USERNAME" -p "$REGISTRY_PASSWORD" "$REGISTRY_URL"
    - echo "Successfully logged in to registry"
  script:
    - export SERVICE_NAME="${CI_JOB_NAME#build:}"
    - export IMAGE_TAG="${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/${SERVICE_NAME}:${COMMIT_SHA}"
    - export IMAGE_TAG_LATEST="${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/${SERVICE_NAME}:latest"
    - echo "=========================================="
    - echo "Building Docker image"
    - echo "=========================================="
    - echo "Service: $SERVICE_NAME"
    - echo "Image tag: $IMAGE_TAG"
    - echo "Image tag (latest): $IMAGE_TAG_LATEST"
    - echo "Dockerfile: $DOCKERFILE_PATH"
    - echo "Build context: $BUILD_CONTEXT"
    - echo "Commit SHA: $COMMIT_SHA"
    - echo "=========================================="
    - echo "Building Docker image..."
    - docker build -t "$IMAGE_TAG" -t "$IMAGE_TAG_LATEST" -f "$DOCKERFILE_PATH" "$BUILD_CONTEXT"
    - echo "Pushing Docker image: $IMAGE_TAG"
    - docker push "$IMAGE_TAG"
    - echo "Pushing Docker image (latest): $IMAGE_TAG_LATEST"
    - docker push "$IMAGE_TAG_LATEST"
    - echo "✅ Image pushed successfully: $IMAGE_TAG"
  after_script:
    - docker logout "$REGISTRY_URL" || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ============================================
# Backend Services
# ============================================

build:arch-repo-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/arch-repo-service/Dockerfile"
    BUILD_CONTEXT: "."
  tags:
    - docker

build:tenant-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/tenant-service/Dockerfile"
    BUILD_CONTEXT: "."
  tags:
    - docker

build:hasura-sync-service:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/backend/apps/hasura-sync-service/Dockerfile"
    BUILD_CONTEXT: "."
  tags:
    - docker

# ============================================
# Frontend
# ============================================

build:portal:
  extends: .build_docker_image
  variables:
    DOCKERFILE_PATH: "packages/portal/Dockerfile"
    BUILD_CONTEXT: "."
  tags:
    - docker

# ============================================
# Deploy (опционально, для автоматического обновления образов в Kubernetes)
# ============================================

# Примечание: Для автоматического обновления образов в Kubernetes можно использовать:
# 1. ArgoCD Image Updater (рекомендуется)
# 2. Или обновлять манифесты через kubectl в этом stage

deploy:update-images:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - export COMMIT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - echo "Images built successfully:"
    - echo "- arch-repo-service:${COMMIT_SHA}"
    - echo "- tenant-service:${COMMIT_SHA}"
    - echo "- hasura-sync-service:${COMMIT_SHA}"
    - echo "- portal:${COMMIT_SHA}"
    - echo ""
    - echo "To update images in Kubernetes, use ArgoCD Image Updater or update manifests manually"
    - |
      echo "Example: kubectl set image deployment/arch-repo-service arch-repo-service=${REGISTRY_URL}/${REGISTRY_IMAGE_PREFIX}/arch-repo-service:${COMMIT_SHA} -n platform"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
