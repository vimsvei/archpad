apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # GitLab Repository Credentials (должен быть первым, чтобы ArgoCD мог синхронизировать)
  - repo-creds/gitlab-repo-creds.secret.yaml
  
  # Проект Argo
  - projects/platform.project.yaml

  # ArgoCD Application для управления всеми другими Applications
  # Отключено - используем только отдельные Applications для каждого сервиса
  # - apps/applications/applications.app.yaml

  # После Traefik CRD
  - apps/traefik/traefik-redirect-to-https.middleware.yaml
  - apps/traefik/traefik-dashboard-basicauth-secret.yaml
  - apps/traefik/traefik-dashboard-basicauth.middleware.yaml
  - apps/traefik/traefik-dashboard-root-redirect.middleware.yaml
  - apps/traefik/traefik-dashboard.ingressroute.yaml
  - apps/traefik/traefik-dashboard-http.ingressroute.yaml
  - apps/argocd/argocd.middleware.yaml
  - apps/argocd/argocd.ingressroute.yaml

  # RBAC для cert-manager TimeWeb webhook (после cert-manager аддона)
  - apps/tls/cert-manager-timeweb-webhook-rbac.yaml

  # Серты (после cert-manager + webhook, которые вы ставите аддоном)
  - apps/tls/issuer-timeweb.clusterissuer.yaml
  - apps/argocd/argocd-wildcard.certificate.yaml

  # Vault (после сертификатов)
  - apps/vault/storageclass-hostpath.yaml
  - apps/vault/persistentvolume-hostpath.yaml
  - apps/vault/vault.middleware.yaml
  - apps/vault/vault-http.ingressroute.yaml
  - apps/vault/vault.ingressroute.yaml
  # Vault политики (должны быть применены до настройки ролей)
  - apps/vault/vault-setup-policy.configmap.yaml
  - apps/vault/vault-setup-policy.job.yaml

  # Vault role для Ory компонентов (до Ory Applications)
  - apps/ory/secure-vault-role.configmap.yaml
  - apps/ory/secure-vault-role.job.yaml

  # Monitoring Application создается через platform-applications (directory recurse)
  # Не добавляем сюда, чтобы избежать SharedResourceWarning

