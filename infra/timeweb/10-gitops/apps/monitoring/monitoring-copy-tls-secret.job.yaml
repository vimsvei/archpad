apiVersion: batch/v1
kind: Job
metadata:
  name: monitoring-copy-tls-secret
  namespace: monitoring
  annotations:
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    metadata:
      annotations:
        argocd.argoproj.io/hook-weight: "0"
    spec:
      serviceAccountName: default
      restartPolicy: Never
      containers:
        - name: copy-secret
          image: bitnami/kubectl:latest
          command: ["sh", "-c"]
          args:
            - |
              set -e
              echo "Checking if wildcard-archpad-pro-tls exists in namespace monitoring..."

              if kubectl get secret wildcard-archpad-pro-tls -n monitoring >/dev/null 2>&1; then
                echo "✓ Secret wildcard-archpad-pro-tls already exists in namespace monitoring"
                exit 0
              fi

              echo "Secret not found in monitoring namespace. Searching for source secret..."

              SOURCE_NS=""
              for ns in monitoring platform traefik argocd; do
                if kubectl get secret wildcard-archpad-pro-tls -n "$ns" >/dev/null 2>&1; then
                  SOURCE_NS="$ns"
                  echo "Found secret in namespace: $ns"
                  break
                else
                  echo "Secret not found in namespace: $ns (may not have permissions to read)"
                fi
              done

              if [ -z "$SOURCE_NS" ] || [ "$SOURCE_NS" = "monitoring" ]; then
                echo "WARNING: Source secret wildcard-archpad-pro-tls not found or not accessible."
                echo "This is not critical - Grafana will work once the secret is available."
                exit 0
              fi

              echo "Copying secret from namespace $SOURCE_NS to monitoring..."
              kubectl get secret wildcard-archpad-pro-tls -n "$SOURCE_NS" -o yaml | \
                sed "s/namespace: $SOURCE_NS/namespace: monitoring/" | \
                sed '/resourceVersion:/d' | \
                sed '/uid:/d' | \
                sed '/creationTimestamp:/d' | \
                kubectl apply -f -

              echo "✓ Successfully copied wildcard-archpad-pro-tls to namespace monitoring"
  backoffLimit: 3
