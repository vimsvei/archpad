apiVersion: apps/v1
kind: Deployment
metadata:
  name: landing
  namespace: platform
  annotations:
    argocd.argoproj.io/sync-wave: "60"
    argocd-image-updater.argoproj.io/image-list: landing=archpad-cr.registry.twcstorage.ru/archpad/landing
    argocd-image-updater.argoproj.io/write-back-method: git
    argocd-image-updater.argoproj.io/git-branch: main
  labels:
    app: landing
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: landing
  template:
    metadata:
      labels:
        app: landing
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-secret-landing: "kv/data/archpad/demo/frontend/landing"
        vault.hashicorp.com/agent-inject-template-landing: |
          {{- $landing := secret "kv/data/archpad/demo/frontend/landing" }}
          {{- $tolgeeFront := secret "kv/data/archpad/demo/tolgee/front" }}
          #!/usr/bin/env sh
          export NEXT_PUBLIC_TOLGEE_API_KEY="{{ $landing.Data.data.NEXT_PUBLIC_TOLGEE_API_KEY }}"
          export NEXT_PUBLIC_TOLGEE_API_URL="{{ $tolgeeFront.Data.data.NEXT_PUBLIC_TOLGEE_API_URL }}"
          export TOLGEE_API_URL="{{ $tolgeeFront.Data.data.TOLGEE_API_URL }}"
          {{- if $landing.Data.data.NEXT_PUBLIC_SITE_URL }}
          export NEXT_PUBLIC_SITE_URL="{{ $landing.Data.data.NEXT_PUBLIC_SITE_URL }}"
          {{- else }}
          export NEXT_PUBLIC_SITE_URL="https://archpad.pro"
          {{- end }}
        vault.hashicorp.com/role: "platform"
    spec:
      affinity:
        podAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - arch-repo-service
                        - tenant-service
                        - portal
                        - landing
                        - hasura
                        - tolgee
                        - mailpit
                        - keycloak
                        - oathkeeper
                topologyKey: kubernetes.io/hostname
      serviceAccountName: landing
      containers:
        - name: landing
          image: archpad-cr.registry.twcstorage.ru/archpad/landing:latest
          command: ["sh", "-c"]
          args:
            - |
              echo "Loading Vault secrets..." >&2
              . /vault/secrets/landing
              # Trim whitespace from Tolgee URLs (Vault may have leading/trailing spaces)
              export TOLGEE_API_URL=$(echo "$TOLGEE_API_URL" | tr -d ' \t\n\r')
              export NEXT_PUBLIC_TOLGEE_API_URL=$(echo "$NEXT_PUBLIC_TOLGEE_API_URL" | tr -d ' \t\n\r')
              echo "Starting landing..." >&2
              cd /app/packages/frontend/landing
              exec env \
                NEXT_PUBLIC_TOLGEE_API_URL="$NEXT_PUBLIC_TOLGEE_API_URL" \
                NEXT_PUBLIC_TOLGEE_API_KEY="$NEXT_PUBLIC_TOLGEE_API_KEY" \
                NEXT_PUBLIC_SITE_URL="$NEXT_PUBLIC_SITE_URL" \
                TOLGEE_API_URL="$TOLGEE_API_URL" \
                node server.js
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
          env:
            - name: NODE_ENV
              value: "production"
            - name: PORT
              value: "3000"
            - name: HOSTNAME
              value: "0.0.0.0"
            - name: NEXT_TELEMETRY_DISABLED
              value: "1"
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 5
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 256Mi
