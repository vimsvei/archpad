apiVersion: apps/v1
kind: Deployment
metadata:
  name: portal
  namespace: platform
  annotations:
    argocd.argoproj.io/sync-wave: "60"
  labels:
    app: portal
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: portal
  template:
    metadata:
      labels:
        app: portal
      annotations:
        # Vault Agent Injector аннотации для чтения секретов из Vault
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-secret-portal: "kv/data/archpad/demo/frontend/portal"
        vault.hashicorp.com/agent-inject-secret-service-token: "kv/data/archpad/demo/backend/service-token"
        vault.hashicorp.com/agent-inject-template-portal: |
          {{- $portal := secret "kv/data/archpad/demo/frontend/portal" }}
          {{- $token := secret "kv/data/archpad/demo/backend/service-token" }}
          {{- $hasuraEndpoint := secret "kv/data/archpad/demo/hasura/endpoint" }}
          {{- $hasuraSecret := secret "kv/data/archpad/demo/hasura/secret" }}
          {{- $tolgeeFront := secret "kv/data/archpad/demo/tolgee/front" }}
          # Экспортируем переменные окружения для Portal
          # Prefer explicit public Hasura URL from portal secret; fallback to internal Hasura endpoint (in-cluster).
          {{- if $portal.Data.data.NEXT_PUBLIC_HASURA_GRAPHQL_URL }}
          export NEXT_PUBLIC_HASURA_GRAPHQL_URL="{{ $portal.Data.data.NEXT_PUBLIC_HASURA_GRAPHQL_URL }}"
          {{- else }}
          export NEXT_PUBLIC_HASURA_GRAPHQL_URL="{{ $hasuraEndpoint.Data.data.HASURA_INTERNAL_URL }}"
          {{- end }}
          export HASURA_INTERNAL_URL="{{ $hasuraEndpoint.Data.data.HASURA_INTERNAL_URL }}"
          export HASURA_GRAPHQL_ADMIN_SECRET="{{ $hasuraSecret.Data.data.HASURA_GRAPHQL_ADMIN_SECRET }}"
          export NEXT_PUBLIC_TOLGEE_API_URL="{{ $tolgeeFront.Data.data.NEXT_PUBLIC_TOLGEE_API_URL }}"
          export TOLGEE_API_URL="{{ $tolgeeFront.Data.data.TOLGEE_API_URL }}"
          export NEXT_PUBLIC_TOLGEE_API_KEY="{{ $portal.Data.data.NEXT_PUBLIC_TOLGEE_API_KEY }}"
          export NEXT_PUBLIC_URL="{{ $portal.Data.data.NEXT_PUBLIC_URL }}"
          export AUTH_SERVICE_INTERNAL_URL="http://auth-service.platform.svc:3000"
          export INTERNAL_SERVICE_TOKEN="{{ $token.Data.data.INTERNAL_SERVICE_TOKEN }}"
          {{- if $portal.Data.data.API_GATEWAY_INTERNAL_URL }}
          export API_GATEWAY_INTERNAL_URL="{{ $portal.Data.data.API_GATEWAY_INTERNAL_URL }}"
          {{- end }}
          {{- if $portal.Data.data.NEXT_PUBLIC_API_GRAPHQL_URI }}
          export NEXT_PUBLIC_API_GRAPHQL_URI="{{ $portal.Data.data.NEXT_PUBLIC_API_GRAPHQL_URI }}"
          {{- end }}
          {{- if $portal.Data.data.NEXT_PUBLIC_API_REST_URI }}
          export NEXT_PUBLIC_API_REST_URI="{{ $portal.Data.data.NEXT_PUBLIC_API_REST_URI }}"
          {{- end }}
        vault.hashicorp.com/role: "platform"
    spec:
      # Группируем поды на меньшем количестве нод для оптимизации использования ресурсов
      affinity:
        podAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - arch-repo-service
                        - tenant-service
                        - portal
                        - hasura
                        - tolgee
                        - mailpit
                        - keycloak
                        - oathkeeper
                topologyKey: kubernetes.io/hostname
      serviceAccountName: portal
      containers:
        - name: portal
          image: archpad-cr.registry.twcstorage.ru/archpad/portal:main-36f450ed
          command: ["sh", "-c"]
          args:
            - |
              # Функция для маскирования секретов (первые 3 и последние 3 символа)
              mask_secret() {
                local value="$1"
                if [ -z "$value" ] || [ "$value" = "<no value>" ]; then
                  echo "<not set>"
                  return
                fi
                local len=${#value}
                if [ $len -le 6 ]; then
                  echo "******"
                else
                  # Извлекаем первые 3 символа
                  local prefix=$(echo "$value" | cut -c1-3)
                  # Извлекаем последние 3 символа через sed
                  local suffix=$(echo "$value" | sed 's/.*\(...\)$/\1/')
                  # Создаем строку звездочек нужной длины
                  local stars=$(printf '%*s' $((len - 6)) '' | tr ' ' '*')
                  echo "${prefix}${stars}${suffix}"
                fi
              }
              
              # Загружаем секреты из Vault Agent Injector
              set -a
              . /vault/secrets/portal
              set +a
              # Trim whitespace from Tolgee URLs (Vault may have leading/trailing spaces)
              export TOLGEE_API_URL=$(echo "$TOLGEE_API_URL" | tr -d ' ')
              export NEXT_PUBLIC_TOLGEE_API_URL=$(echo "$NEXT_PUBLIC_TOLGEE_API_URL" | tr -d ' ')
              
              # Логируем все переменные окружения с маскированием
              echo "=========================================="
              echo "Portal Environment Variables (masked):"
              echo "=========================================="
              echo "# Portal Configuration"
              echo "NEXT_PUBLIC_URL: $(mask_secret "$NEXT_PUBLIC_URL")"
              echo ""
              echo "# Auth Service (BFF)"
              echo "AUTH_SERVICE_INTERNAL_URL: $(mask_secret "$AUTH_SERVICE_INTERNAL_URL")"
              echo "INTERNAL_SERVICE_TOKEN: $(mask_secret "$INTERNAL_SERVICE_TOKEN")"
              echo ""
              echo "# Hasura GraphQL"
              echo "NEXT_PUBLIC_HASURA_GRAPHQL_URL: $(mask_secret "$NEXT_PUBLIC_HASURA_GRAPHQL_URL")"
              echo "HASURA_INTERNAL_URL: $(mask_secret "$HASURA_INTERNAL_URL")"
              echo "HASURA_GRAPHQL_ADMIN_SECRET: $(mask_secret "$HASURA_GRAPHQL_ADMIN_SECRET")"
              echo ""
              echo "# Tolgee (i18n)"
              echo "NEXT_PUBLIC_TOLGEE_API_URL: $(mask_secret "$NEXT_PUBLIC_TOLGEE_API_URL")"
              echo "NEXT_PUBLIC_TOLGEE_API_KEY: $(mask_secret "$NEXT_PUBLIC_TOLGEE_API_KEY")"
              echo ""
              # Проверяем, что переменные Tolgee установлены
              if [ -z "$NEXT_PUBLIC_TOLGEE_API_URL" ] || [ "$NEXT_PUBLIC_TOLGEE_API_URL" = "<no value>" ]; then
                echo "WARNING: NEXT_PUBLIC_TOLGEE_API_URL is not set or has invalid value"
                echo "WARNING: Tolgee translations will not work!"
              fi
              if [ -z "$NEXT_PUBLIC_TOLGEE_API_KEY" ] || [ "$NEXT_PUBLIC_TOLGEE_API_KEY" = "<no value>" ]; then
                echo "WARNING: NEXT_PUBLIC_TOLGEE_API_KEY is not set or has invalid value"
                echo "WARNING: Tolgee translations will not work!"
              fi
              echo ""
              echo "# API Gateway (Oathkeeper)"
              if [ -n "$API_GATEWAY_INTERNAL_URL" ]; then
                echo "API_GATEWAY_INTERNAL_URL: $(mask_secret "$API_GATEWAY_INTERNAL_URL")"
              else
                echo "API_GATEWAY_INTERNAL_URL: <not set>"
              fi
              if [ -n "$NEXT_PUBLIC_API_GRAPHQL_URI" ]; then
                echo "NEXT_PUBLIC_API_GRAPHQL_URI: $(mask_secret "$NEXT_PUBLIC_API_GRAPHQL_URI")"
              else
                echo "NEXT_PUBLIC_API_GRAPHQL_URI: <not set>"
              fi
              if [ -n "$NEXT_PUBLIC_API_REST_URI" ]; then
                echo "NEXT_PUBLIC_API_REST_URI: $(mask_secret "$NEXT_PUBLIC_API_REST_URI")"
              else
                echo "NEXT_PUBLIC_API_REST_URI: <not set>"
              fi
              echo "=========================================="
              
              # Проверяем, что основные переменные установлены
              if [ -z "$NEXT_PUBLIC_URL" ] || [ "$NEXT_PUBLIC_URL" = "<no value>" ]; then
                echo "ERROR: NEXT_PUBLIC_URL is not set or has invalid value"
                exit 1
              fi
              if [ -z "$NEXT_PUBLIC_HASURA_GRAPHQL_URL" ] || [ "$NEXT_PUBLIC_HASURA_GRAPHQL_URL" = "<no value>" ]; then
                echo "ERROR: NEXT_PUBLIC_HASURA_GRAPHQL_URL is not set or has invalid value"
                exit 1
              fi
              # Запускаем Next.js приложение с явной передачей переменных окружения
              echo "Portal starting..."
              # Экспортируем все переменные окружения для Next.js
              export NEXT_PUBLIC_HASURA_GRAPHQL_URL HASURA_INTERNAL_URL HASURA_GRAPHQL_ADMIN_SECRET NEXT_PUBLIC_TOLGEE_API_URL NEXT_PUBLIC_TOLGEE_API_KEY TOLGEE_API_URL NEXT_PUBLIC_URL
              [ -n "$API_GATEWAY_INTERNAL_URL" ] && export API_GATEWAY_INTERNAL_URL
              [ -n "$NEXT_PUBLIC_API_GRAPHQL_URI" ] && export NEXT_PUBLIC_API_GRAPHQL_URI
              [ -n "$NEXT_PUBLIC_API_REST_URI" ] && export NEXT_PUBLIC_API_REST_URI
              
              # В Next.js standalone режиме переменные NEXT_PUBLIC_* должны быть доступны через process.env
              # Передаем их явно в процесс node через env
              exec env \
                NEXT_PUBLIC_HASURA_GRAPHQL_URL="$NEXT_PUBLIC_HASURA_GRAPHQL_URL" \
                HASURA_INTERNAL_URL="$HASURA_INTERNAL_URL" \
                HASURA_GRAPHQL_ADMIN_SECRET="$HASURA_GRAPHQL_ADMIN_SECRET" \
                NEXT_PUBLIC_TOLGEE_API_URL="$NEXT_PUBLIC_TOLGEE_API_URL" \
                NEXT_PUBLIC_TOLGEE_API_KEY="$NEXT_PUBLIC_TOLGEE_API_KEY" \
                TOLGEE_API_URL="$TOLGEE_API_URL" \
                NEXT_PUBLIC_URL="$NEXT_PUBLIC_URL" \
                AUTH_SERVICE_INTERNAL_URL="$AUTH_SERVICE_INTERNAL_URL" \
                INTERNAL_SERVICE_TOKEN="$INTERNAL_SERVICE_TOKEN" \
                ${API_GATEWAY_INTERNAL_URL:+API_GATEWAY_INTERNAL_URL="$API_GATEWAY_INTERNAL_URL"} \
                ${NEXT_PUBLIC_API_GRAPHQL_URI:+NEXT_PUBLIC_API_GRAPHQL_URI="$NEXT_PUBLIC_API_GRAPHQL_URI"} \
                ${NEXT_PUBLIC_API_REST_URI:+NEXT_PUBLIC_API_REST_URI="$NEXT_PUBLIC_API_REST_URI"} \
                node server.js
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
          env:
            - name: NODE_ENV
              value: "production"
            - name: PORT
              value: "3000"
            - name: HOSTNAME
              value: "0.0.0.0"
            - name: NEXT_TELEMETRY_DISABLED
              value: "1"
          livenessProbe:
            httpGet:
              path: /manifest.webmanifest
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /manifest.webmanifest
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 5
          resources:
            # Оптимизировано для демо-стенда (2 ноды по 2 CPU, 2GB RAM)
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 256Mi
