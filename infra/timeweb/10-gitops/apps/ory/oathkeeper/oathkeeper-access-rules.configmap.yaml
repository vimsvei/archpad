apiVersion: v1
kind: ConfigMap
metadata:
  name: oathkeeper-access-rules
  namespace: secure
  annotations:
    argocd.argoproj.io/sync-wave: "50"
data:
  access-rules.yml: |
    # ==== GraphQL Hasura через Oathkeeper ====
    # JWT first; if no/invalid token, anonymous allows through (HASURA_GRAPHQL_UNAUTHORIZED_ROLE=user).
    - id: hasura-graphql
      match:
        url: <https|http>://api.archpad.pro/graphql<(/.*)?>
        methods: ["GET", "POST", "OPTIONS"]
      upstream:
        url: http://hasura.platform:8080
        preserve_host: true
        strip_path: /graphql
      authenticators:
        - handler: jwt
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers:
              X-Hasura-User-Id: "{{ .Subject }}"
              # Role from Keycloak groups (first group, lowercased); fallback "user" when no groups (anonymous)
              X-Hasura-Role: "{{ default \"user\" (lower (printIndex .Extra.groups 0)) }}"
              X-Hasura-Allowed-Roles: "{{ if .Extra.groups }}{{ join \",\" .Extra.groups | lower }}{{ else }}user{{ end }}"

    # ==== Auth-service через Oathkeeper (публичный доступ) ====
    # Единая схема REST: api.archpad.pro/rest/<service>/<route>
    # /rest/auth-service/auth/register → strip /rest/auth-service → remainder /auth/register → auth-service
    - id: auth-service
      match:
        url: <https|http>://api.archpad.pro/rest/auth-service<(/.*)?>
        methods: ["GET", "POST", "OPTIONS"]
      upstream:
        url: http://auth-service.platform:3000
        preserve_host: true
        strip_path: /rest/auth-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: noop

    # ==== Swagger API документация для arch-repo-service (публичный доступ) ====
    - id: arch-repo-api-docs
      match:
        url: <https|http>://api.archpad.pro/rest/arch-repo-service/api-docs.*
        methods: ["GET", "OPTIONS"]
      upstream:
        url: http://arch-repo-service.platform:3000
        preserve_host: false
        strip_path: /rest/arch-repo-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers: {}

    - id: arch-repo-api-json
      match:
        url: <https|http>://api.archpad.pro/rest/arch-repo-service/api-json.*
        methods: ["GET", "OPTIONS"]
      upstream:
        url: http://arch-repo-service.platform:3000
        preserve_host: false
        strip_path: /rest/arch-repo-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers: {}

    # ==== Swagger API документация для tenant-service (публичный доступ) ====
    - id: tenant-service-api-docs
      match:
        url: <https|http>://api.archpad.pro/rest/tenant-service/api-docs.*
        methods: ["GET", "OPTIONS"]
      upstream:
        url: http://tenant-service.platform:3000
        preserve_host: false
        strip_path: /rest/tenant-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers: {}

    - id: tenant-service-api-json
      match:
        url: <https|http>://api.archpad.pro/rest/tenant-service/api-json.*
        methods: ["GET", "OPTIONS"]
      upstream:
        url: http://tenant-service.platform:3000
        preserve_host: false
        strip_path: /rest/tenant-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers: {}

    # ==== Arch-repo-service через Oathkeeper (требует авторизации) ====
    # Исключаем /api-docs и /api-json из этого правила (они обрабатываются отдельно выше)
    # Используем negative lookahead, чтобы не матчить api-docs/api-json
    - id: arch-repo-api
      match:
        url: <https|http>://api.archpad.pro/rest/arch-repo-service/(?!api-docs|api-json).+
        methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
      upstream:
        url: http://arch-repo-service.platform:3000
        preserve_host: true
        strip_path: /rest/arch-repo-service
      authenticators:
        - handler: jwt
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers:
              X-Archpad-User-Id: "{{ .Subject }}"

    # ==== Tenant-service через Oathkeeper (требует авторизации) ====
    # Исключаем /api-docs и /api-json из этого правила (они обрабатываются отдельно выше)
    - id: tenant-service-api
      match:
        url: <https|http>://api.archpad.pro/rest/tenant-service/(?!api-docs|api-json).+
        methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
      upstream:
        url: http://tenant-service.platform:3000
        preserve_host: true
        strip_path: /rest/tenant-service
      authenticators:
        - handler: jwt
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers:
              X-Archpad-User-Id: "{{ .Subject }}"
