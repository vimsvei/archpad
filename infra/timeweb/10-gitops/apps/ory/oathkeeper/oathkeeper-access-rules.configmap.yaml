apiVersion: v1
kind: ConfigMap
metadata:
  name: oathkeeper-access-rules
  namespace: secure
  annotations:
    argocd.argoproj.io/sync-wave: "50"
data:
  access-rules.yml: |
    # ==== GraphQL Hasura через Oathkeeper ====
    # JWT first; if no/invalid token, anonymous allows through (HASURA_GRAPHQL_UNAUTHORIZED_ROLE=user).
    - id: hasura-graphql
      match:
        url: <https|http>://api.archpad.pro/graphql<(/.*)?>
        methods: ["GET", "POST", "OPTIONS"]
      upstream:
        url: http://hasura.platform:8080
        preserve_host: true
        strip_path: /graphql
      authenticators:
        - handler: jwt
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers:
              X-Hasura-User-Id: "{{ .Subject }}"
              # Role from Keycloak groups (first group, lowercased); fallback "user" when no groups (anonymous)
              X-Hasura-Role: "{{ default \"user\" (lower (printIndex .Extra.groups 0)) }}"
              X-Hasura-Allowed-Roles: "{{ if .Extra.groups }}{{ join \",\" .Extra.groups | lower }}{{ else }}user{{ end }}"

    # ==== Auth-service через Oathkeeper (публичный доступ) ====
    # Единая схема REST: api.archpad.pro/rest/<service>/<route>
    # /rest/auth-service/auth/register → strip /rest/auth-service → remainder /auth/register → auth-service
    - id: auth-service
      match:
        url: <https|http>://api.archpad.pro/rest/auth-service<(/.*)?>
        methods: ["GET", "POST", "OPTIONS"]
      upstream:
        url: http://auth-service.platform:3000
        preserve_host: true
        strip_path: /rest/auth-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: noop

    # ==== Swagger arch-repo-service (публичный доступ) ====
    - id: arch-repo-api-docs
      match:
        url: <https|http>://api.archpad.pro/rest/arch-repo-service</api-docs.*>
        methods: ["GET", "OPTIONS"]
      upstream:
        url: http://arch-repo-service.platform:3000
        preserve_host: false
        strip_path: /rest/arch-repo-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers: {}

    - id: arch-repo-api-json
      match:
        url: <https|http>://api.archpad.pro/rest/arch-repo-service</api-json.*>
        methods: ["GET", "OPTIONS"]
      upstream:
        url: http://arch-repo-service.platform:3000
        preserve_host: false
        strip_path: /rest/arch-repo-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers: {}

    # ==== Arch-repo-service API (требует JWT, user ID из токена Keycloak) ====
    - id: arch-repo-api
      match:
        url: <https|http>://api.archpad.pro/rest/arch-repo-service</(architecture-styles|critical-levels|license-types|node-types|software-types|protocol-types|component-states|failure-handlings|failover-types|recovery-times|redundancy-types|monitoring-levels|scaling-types|security-zones|solutions|application-components|application-interfaces|application-functions|data-objects|application-events|system-software|import|directories|technology-networks|technology-host-nodes|technology-cluster-nodes|technology-device-nodes|business-actors|business-roles|business-products|capabilities|locations|stakeholders|motivation)(/.*)?>
        methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
      upstream:
        url: http://arch-repo-service.platform:3000
        preserve_host: true
        strip_path: /rest/arch-repo-service
      authenticators:
        - handler: jwt
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers:
              X-Archpad-User-Id: "{{ .Subject }}"
              # Forward tenant from Next.js proxy (cookie archpad_tenant_id -> x-archpad-tenant-ids) to set correct tenant_id in DB
              X-Archpad-Tenant-Ids: '{{ .MatchContext.Header.Get "X-Archpad-Tenant-Ids" }}'

    # ==== Swagger tenant-service (публичный доступ) ====
    - id: tenant-service-api-docs
      match:
        url: <https|http>://api.archpad.pro/rest/tenant-service</api-docs.*>
        methods: ["GET", "OPTIONS"]
      upstream:
        url: http://tenant-service.platform:3000
        preserve_host: false
        strip_path: /rest/tenant-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers: {}

    - id: tenant-service-api-json
      match:
        url: <https|http>://api.archpad.pro/rest/tenant-service</api-json.*>
        methods: ["GET", "OPTIONS"]
      upstream:
        url: http://tenant-service.platform:3000
        preserve_host: false
        strip_path: /rest/tenant-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers: {}

    # ==== Tenant-service API (требует JWT, user ID из токена Keycloak) ====
    - id: tenant-service-api
      match:
        url: <https|http>://api.archpad.pro/rest/tenant-service</(tenants|workspaces|internal)(/.*)?>
        methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
      upstream:
        url: http://tenant-service.platform:3000
        preserve_host: true
        strip_path: /rest/tenant-service
      authenticators:
        - handler: jwt
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers:
              X-Archpad-User-Id: "{{ .Subject }}"
