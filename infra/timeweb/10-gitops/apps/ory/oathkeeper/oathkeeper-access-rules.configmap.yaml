apiVersion: v1
kind: ConfigMap
metadata:
  name: oathkeeper-access-rules
  namespace: secure
  annotations:
    argocd.argoproj.io/sync-wave: "50"
data:
  access-rules.yml: |
    # ==== GraphQL Hasura через Oathkeeper ====
    - id: hasura-graphql
      match:
        url: <https|http>://api.archpad.pro/graphql<(/.*)?>
        methods: ["GET", "POST", "OPTIONS"]
      upstream:
        url: http://hasura.platform:8080
        preserve_host: true
        strip_path: /graphql
      authenticators:
        - handler: oauth2_introspection
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers:
              X-Hasura-User-Id: "{{ .Subject }}"
              X-Hasura-Role: "public"
              X-Hasura-Allowed-Roles: "public"

    # ==== Swagger API документация для arch-repo-service (публичный доступ) ====
    - id: arch-repo-api-docs
      match:
        url: <https|http>://api.archpad.pro/rest/arch-repo-service/api-docs
        methods: ["GET", "OPTIONS"]
      upstream:
        url: http://arch-repo-service.platform:3000
        preserve_host: false
        strip_path: /rest/arch-repo-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators: []

    - id: arch-repo-api-json
      match:
        url: <https|http>://api.archpad.pro/rest/arch-repo-service/api-json
        methods: ["GET", "OPTIONS"]
      upstream:
        url: http://arch-repo-service.platform:3000
        preserve_host: false
        strip_path: /rest/arch-repo-service
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators: []

    # ==== Arch-repo-service через Oathkeeper (требует авторизации) ====
    # Исключаем /api-docs и /api-json из этого правила (они обрабатываются отдельно выше)
    # Используем negative lookahead, чтобы не матчить api-docs/api-json
    - id: arch-repo-api
      match:
        url: <https|http>://api.archpad.pro/rest/arch-repo-service/(?!api-docs|api-json).+
        methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
      upstream:
        url: http://arch-repo-service.platform:3000
        preserve_host: true
        strip_path: /rest/arch-repo-service
      authenticators:
        - handler: oauth2_introspection
      authorizer:
        handler: allow
      mutators:
        - handler: header
          config:
            headers:
              X-Archpad-User-Id: "{{ .Subject }}"
