apiVersion: v1
kind: ConfigMap
metadata:
  name: hydra-init-client
  namespace: secure
  annotations:
    argocd.argoproj.io/sync-wave: "50"
data:
  entrypoint.sh: |
    #!/usr/bin/env sh
    set -eu

    HYDRA_ADMIN_URL="${HYDRA_ADMIN_URL:-http://hydra:4445}"

    echo "[hydra-init-client] Waiting for Hydra admin at ${HYDRA_ADMIN_URL} ..."
    tries=0
    until curl -fsS "${HYDRA_ADMIN_URL}/health/ready" >/dev/null 2>&1; do
      tries=$((tries+1))
      if [ "$tries" -ge 60 ]; then
        echo "[hydra-init-client] Hydra admin not ready after ${tries} tries"
        exit 1
      fi
      sleep 2
    done
    echo "[hydra-init-client] Hydra admin is ready"

    sh "/init-client/upsert-portal-client.sh"
    sh "/init-client/upsert-oathkeeper-client.sh"

    echo "[hydra-init-client] Done"
  upsert-portal-client.sh: |
    #!/usr/bin/env sh
    set -eu

    HYDRA_ADMIN_URL="${HYDRA_ADMIN_URL:-http://hydra:4445}"
    CLIENT_ID="${OAUTH_CLIENT_ID:-archpad-portal}"
    PORTAL_PUBLIC_URL="${PORTAL_PUBLIC_URL:-https://portal.archpad.pro}"
    REDIRECT_URI="${NEXT_PUBLIC_OAUTH_REDIRECT_URI:-${PORTAL_PUBLIC_URL}/oauth/callback}"
    SCOPE="${OAUTH_SCOPE:-openid offline_access}"
    CLIENT_SECRET="${OAUTH_CLIENT_SECRET:?OAUTH_CLIENT_SECRET is required (expected from Vault kv/data/archpad/demo/ory/hydra/oauth)}"
    AUTH_METHOD="client_secret_basic"

    # Добавляем redirect URI для локальной разработки
    REDIRECT_URI_LOCAL="http://localhost:3000/oauth/callback"
    REDIRECT_URI_LOCAL_ALT="http://localhost:3001/oauth/callback"

    payload="$(cat <<JSON
    {
      "client_id": "${CLIENT_ID}",
      "client_name": "Archpad Portal (PKCE)",
      "redirect_uris": ["${REDIRECT_URI}", "${REDIRECT_URI_LOCAL}", "${REDIRECT_URI_LOCAL_ALT}"],
      "grant_types": ["authorization_code", "refresh_token"],
      "response_types": ["code"],
      "scope": "${SCOPE}",
      "token_endpoint_auth_method": "${AUTH_METHOD}",
      "client_secret": "${CLIENT_SECRET}"
    }
    JSON
    )"

    code="$(curl -sS -o /dev/null -w "%{http_code}" "${HYDRA_ADMIN_URL}/clients/${CLIENT_ID}" || true)"
    if [ "${code}" = "200" ]; then
      echo "[hydra-init-client] Updating portal OAuth client: ${CLIENT_ID}"
      curl -sS -X PUT "${HYDRA_ADMIN_URL}/clients/${CLIENT_ID}" \
        -H "Content-Type: application/json" \
        --data "${payload}" >/dev/null
    else
      echo "[hydra-init-client] Creating portal OAuth client: ${CLIENT_ID}"
      curl -sS -X POST "${HYDRA_ADMIN_URL}/clients" \
        -H "Content-Type: application/json" \
        --data "${payload}" >/dev/null
    fi

    echo "[hydra-init-client] OK: export NEXT_PUBLIC_OAUTH_CLIENT_ID=\"${CLIENT_ID}\""
    echo "[hydra-init-client] OK: export NEXT_PUBLIC_OAUTH_REDIRECT_URI=\"${REDIRECT_URI}\""
  upsert-oathkeeper-client.sh: |
    #!/usr/bin/env sh
    set -eu

    HYDRA_ADMIN_URL="${HYDRA_ADMIN_URL:-http://hydra:4445}"
    CLIENT_ID="${ORY_CLIENT_ID:-archpad-oathkeeper}"
    CLIENT_SECRET="${ORY_CLIENT_SECRET:?ORY_CLIENT_SECRET is required (expected from Vault kv/data/archpad/demo/ory/oathkeeper)}"
    SCOPE="${ORY_INTROSPECT_SCOPE:-introspect}"

    payload="$(cat <<JSON
    {
      "client_id": "${CLIENT_ID}",
      "client_secret": "${CLIENT_SECRET}",
      "client_name": "Archpad Oathkeeper (introspection)",
      "grant_types": ["client_credentials"],
      "response_types": ["token"],
      "scope": "${SCOPE}",
      "token_endpoint_auth_method": "client_secret_basic"
    }
    JSON
    )"

    code="$(curl -sS -o /dev/null -w "%{http_code}" "${HYDRA_ADMIN_URL}/clients/${CLIENT_ID}" || true)"
    if [ "${code}" = "200" ]; then
      echo "[hydra-init-client] Updating oathkeeper introspection client: ${CLIENT_ID}"
      curl -sS -X PUT "${HYDRA_ADMIN_URL}/clients/${CLIENT_ID}" \
        -H "Content-Type: application/json" \
        --data "${payload}" >/dev/null
    else
      echo "[hydra-init-client] Creating oathkeeper introspection client: ${CLIENT_ID}"
      curl -sS -X POST "${HYDRA_ADMIN_URL}/clients" \
        -H "Content-Type: application/json" \
        --data "${payload}" >/dev/null
    fi

    echo "[hydra-init-client] OK: export ORY_CLIENT_ID=\"${CLIENT_ID}\""
    echo "[hydra-init-client] OK: export ORY_CLIENT_SECRET=\"${CLIENT_SECRET}\""
