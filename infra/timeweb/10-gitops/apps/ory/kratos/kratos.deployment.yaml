apiVersion: apps/v1
kind: Deployment
metadata:
  name: kratos
  namespace: secure
  annotations:
    argocd.argoproj.io/sync-wave: "60"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kratos
  template:
    metadata:
      labels:
        app: kratos
      annotations:
        # Vault Agent Injector аннотации для генерации конфига из шаблона
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-secret-kratos: "kv/data/archpad/demo/ory/kratos"
        vault.hashicorp.com/agent-inject-secret-postgres: "kv/data/archpad/demo/postgres"
        # Переопределяем шаблон для секрета kratos - генерируем полный конфиг YAML вместо переменных окружения
        vault.hashicorp.com/agent-inject-template-kratos: |
          {{- $kratos := secret "kv/data/archpad/demo/ory/kratos" }}
          {{- $postgres := secret "kv/data/archpad/demo/postgres" }}
          {{- $password := $kratos.Data.data.KRATOS_DB_PASSWORD | urlquery }}
          {{- $pgHost := $postgres.Data.data.POSTGRES_HOST }}
          {{- $pgPort := $postgres.Data.data.POSTGRES_PORT }}
          dsn: postgres://{{ $kratos.Data.data.KRATOS_DB_USER }}:{{ $password }}@{{ $pgHost }}:{{ $pgPort }}/{{ $kratos.Data.data.KRATOS_DB }}?sslmode=disable&max_conns=20&max_idle_conns=4

          serve:
            public:
              base_url: https://auth.archpad.pro
              port: 4433
              cors:
                enabled: true
                allowed_origins:
                  - https://portal.archpad.pro
                  - https://auth.archpad.pro
                  - https://authz.archpad.pro
                allowed_methods:
                  - GET
                  - POST
                  - PUT
                  - PATCH
                  - DELETE
                allowed_headers:
                  - Authorization
                  - Cookie
                  - Content-Type
                exposed_headers:
                  - Content-Type
                  - Set-Cookie

            admin:
              base_url: http://kratos:4434/
              host: 0.0.0.0
              port: 4434

          selfservice:
            default_browser_return_url: https://portal.archpad.pro/
            allowed_return_urls:
              - https://portal.archpad.pro/
            methods:
              password:
                enabled: true
            flows:
              login:
                ui_url: https://portal.archpad.pro/sign-in
                lifespan: 1h
                style: unified
              registration:
                ui_url: https://portal.archpad.pro/sign-up
                enabled: true
                enable_legacy_one_step: false
                lifespan: 1h
                style: unified
              settings:
                ui_url: https://portal.archpad.pro/settings
                lifespan: 1h
                privileged_session_max_age: 1h
                required_aal: highest_available
              recovery:
                enabled: true
                lifespan: 1h
                notify_unknown_recipients: false
                use: code
                ui_url: https://portal.archpad.pro/recovery
              verification:
                ui_url: https://portal.archpad.pro/verify
                enabled: true
                lifespan: 1h
                notify_unknown_recipients: false
                use: code

          identity:
            default_schema_id: default
            schemas:
              - id: default
                url: file:///etc/config/kratos/identities/default.schema.json

          cookies:
            domain: .archpad.pro
            path: /
            same_site: Lax
            secure: "auto"

          log:
            level: info
            format: json

          secrets:
            default:
              - {{ $kratos.Data.data.KRATOS_SECRET }}

          session:
            lifespan: 720h

          # Email delivery (verification / recovery codes, etc.)
          courier:
            smtp:
              connection_uri: {{ $kratos.Data.data.SMTP_CONNECTION_URI }}
              from_address: {{ $kratos.Data.data.SMTP_FROM_ADDRESS }}
        vault.hashicorp.com/role: "secure"
    spec:
      serviceAccountName: kratos
      containers:
        - name: kratos
          image: oryd/kratos:v25.4.0
          command: ["sh", "-c"]
          args:
            - |
              # Конфиг сгенерирован Vault Agent Injector в /vault/secrets/kratos
              # Копируем его в нужное место
              mkdir -p /etc/config
              cp /vault/secrets/kratos /etc/config/kratos.yml
              # Запускаем Kratos
              exec kratos serve -c /etc/config/kratos.yml --dev --watch-courier
          ports:
            - name: public
              containerPort: 4433
              protocol: TCP
            - name: admin
              containerPort: 4434
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /etc/config
            - name: shared-vault-secrets
              mountPath: /shared-vault-secrets
              readOnly: true
            - name: identity-schema
              mountPath: /etc/config/kratos/identities/default.schema.json
              subPath: default.schema.json
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health/ready
              port: 4434
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 4434
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: config
          emptyDir: {}
        - name: shared-vault-secrets
          emptyDir: {}
        - name: identity-schema
          configMap:
            name: kratos-identity-schema
