apiVersion: v1
kind: ConfigMap
metadata:
  name: secure-vault-role
  namespace: secure
  annotations:
    argocd.argoproj.io/sync-wave: "40"
data:
  entrypoint.sh: |
    #!/usr/bin/env sh
    set -u
    # Не используем set -e, чтобы скрипт продолжал работу при ошибках включения auth method

    VAULT_ADDR="${VAULT_ADDR:-http://vault.vault.svc:8200}"
    VAULT_TOKEN="${VAULT_TOKEN}"
    KUBERNETES_HOST="${KUBERNETES_HOST:-https://kubernetes.default.svc}"
    KUBERNETES_CA_CERT_PATH="/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
    
    echo "[secure-vault-role] Waiting for Vault to be ready at ${VAULT_ADDR}..."
    tries=0
    until curl -fsS "${VAULT_ADDR}/v1/sys/health" >/dev/null 2>&1; do
      tries=$((tries+1))
      if [ "$tries" -ge 60 ]; then
        echo "[secure-vault-role] Vault not ready after ${tries} tries"
        exit 1
      fi
      sleep 2
    done
    echo "[secure-vault-role] Vault is ready"

    # Проверяем, включен ли Kubernetes Auth
    echo "[secure-vault-role] Checking if Kubernetes Auth is enabled..."
    AUTH_LIST=$(curl -sS -H "X-Vault-Token: ${VAULT_TOKEN}" "${VAULT_ADDR}/v1/sys/auth" 2>/dev/null || echo "{}")
    K8S_AUTH_CHECK=$(echo "$AUTH_LIST" | jq -r '.["kubernetes/"] // empty' 2>/dev/null || echo "")
    
    if [ -z "$K8S_AUTH_CHECK" ] || [ "$K8S_AUTH_CHECK" = "null" ]; then
      echo "[secure-vault-role] Kubernetes Auth not found, attempting to enable..."
      CODE=$(curl -sS -o /dev/null -w "%{http_code}" \
        -X POST \
        -H "X-Vault-Token: ${VAULT_TOKEN}" \
        -H "Content-Type: application/json" \
        -d '{"type":"kubernetes"}' \
        "${VAULT_ADDR}/v1/sys/auth/kubernetes" 2>/dev/null || echo "000")
      if [ "$CODE" = "200" ] || [ "$CODE" = "204" ]; then
        echo "[secure-vault-role] Kubernetes Auth enabled"
      elif [ "$CODE" = "403" ]; then
        echo "[secure-vault-role] Kubernetes Auth may already be enabled (403 - permission denied)"
        echo "[secure-vault-role] This is expected if Kubernetes Auth was set up by vault-setup-kubernetes-auth job"
        echo "[secure-vault-role] Continuing with role creation..."
      else
        echo "[secure-vault-role] Warning: Failed to enable Kubernetes Auth (HTTP ${CODE}), but continuing..."
      fi
    else
      echo "[secure-vault-role] Kubernetes Auth already enabled"
    fi

    # Настраиваем Kubernetes Auth config (если еще не настроен)
    echo "[secure-vault-role] Configuring Kubernetes Auth..."
    # Устанавливаем jq если его нет
    if ! command -v jq >/dev/null 2>&1; then
      apk add --no-cache jq >/dev/null 2>&1 || echo "[secure-vault-role] Warning: jq not available, trying base64"
    fi
    # Используем jq для кодирования CA cert (как в hasura-vault-role)
    if command -v jq >/dev/null 2>&1; then
      CA_CERT_JSON=$(cat ${KUBERNETES_CA_CERT_PATH} | jq -Rs .)
    else
      # Fallback на base64 если jq недоступен
      CA_CERT_JSON="\"$(cat ${KUBERNETES_CA_CERT_PATH} | base64 | tr -d '\n')\""
    fi
    curl -fsS -X POST \
      -H "X-Vault-Token: ${VAULT_TOKEN}" \
      -H "Content-Type: application/json" \
      -d "{
        \"kubernetes_host\": \"${KUBERNETES_HOST}\",
        \"kubernetes_ca_cert\": ${CA_CERT_JSON}
      }" \
      "${VAULT_ADDR}/v1/auth/kubernetes/config" >/dev/null 2>&1 || echo "[secure-vault-role] Kubernetes Auth config may already be set (ignoring error)"
    echo "[secure-vault-role] Kubernetes Auth configured"

    # Создаем или обновляем role 'secure' для ServiceAccount'ов в namespace secure
    echo "[secure-vault-role] Creating/updating Vault role 'secure' for ServiceAccounts in namespace 'secure'..."
    curl -fsS -X POST \
      -H "X-Vault-Token: ${VAULT_TOKEN}" \
      -H "Content-Type: application/json" \
      -d '{
        "bound_service_account_names": "oathkeeper,keycloak,keycloak-sync",
        "bound_service_account_namespaces": "secure",
        "policies": "archpad",
        "ttl": "1h"
      }' \
      "${VAULT_ADDR}/v1/auth/kubernetes/role/secure" >/dev/null
    echo "[secure-vault-role] Vault role 'secure' created/updated"

    echo "[secure-vault-role] Done."
