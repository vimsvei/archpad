apiVersion: batch/v1
kind: Job
metadata:
  name: traefik-dashboard-copy-tls-secret
  namespace: traefik
  annotations:
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    metadata:
      annotations:
        argocd.argoproj.io/hook-weight: "0"
    spec:
      serviceAccountName: default
      restartPolicy: Never
      containers:
        - name: copy-secret
          image: bitnami/kubectl:latest
          command: ["sh", "-c"]
          args:
            - |
              set -e
              echo "Checking if wildcard-archpad-pro-tls exists in namespace traefik..."
              
              if kubectl get secret wildcard-archpad-pro-tls -n traefik >/dev/null 2>&1; then
                echo "✓ Secret wildcard-archpad-pro-tls already exists in namespace traefik"
                exit 0
              fi
              
              echo "Secret not found in traefik namespace. Searching for source secret..."
              
              # Ищем secret в разных namespace'ах (в порядке приоритета)
              SOURCE_NS=""
              for ns in argocd platform; do
                if kubectl get secret wildcard-archpad-pro-tls -n "$ns" >/dev/null 2>&1; then
                  SOURCE_NS="$ns"
                  echo "Found secret in namespace: $ns"
                  break
                else
                  echo "Secret not found in namespace: $ns (may not have permissions to read)"
                fi
              done
              
              if [ -z "$SOURCE_NS" ]; then
                echo "WARNING: Secret wildcard-archpad-pro-tls not found or not accessible in any namespace"
                echo "This may be due to RBAC restrictions or the certificate not being issued yet."
                echo "This is not critical - Traefik dashboard will work once the secret is available."
                exit 0  # Не считаем это ошибкой
              fi
              
              echo "Copying secret from namespace $SOURCE_NS to traefik..."
              kubectl get secret wildcard-archpad-pro-tls -n "$SOURCE_NS" -o yaml | \
                sed "s/namespace: $SOURCE_NS/namespace: traefik/" | \
                sed '/resourceVersion:/d' | \
                sed '/uid:/d' | \
                sed '/creationTimestamp:/d' | \
                kubectl apply -f -
              
              echo "✓ Successfully copied wildcard-archpad-pro-tls to namespace traefik"
      backoffLimit: 3