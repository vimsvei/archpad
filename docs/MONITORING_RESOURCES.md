# Ресурсы мониторинга в контексте всего кластера

## Ограничение кластера

**Общее ограничение:** 4 CPU / 8GB RAM на весь кластер

## Текущее использование приложениями (после оптимизации)

| Категория | CPU Requests | RAM Requests | CPU Limits | RAM Limits |
|-----------|--------------|--------------|------------|------------|
| Backend Services | 90m | 192Mi | 300m | 384Mi |
| Frontend | 50m | 128Mi | 150m | 256Mi |
| Инфраструктура | 180m | 448Mi | 400m | 640Mi |
| Безопасность (Ory) | 90m | 192Mi | 300m | 384Mi |
| Утилиты | 100m | 192Mi | 400m | 512Mi |
| **Итого приложения** | **~500m** | **~1152Mi** | **~1450m** | **~2112Mi** |

## Ресурсы мониторинга (оптимизировано)

| Компонент | CPU Requests | RAM Requests | CPU Limits | RAM Limits | Примечание |
|-----------|--------------|--------------|------------|------------|------------|
| Prometheus | 200m | 1Gi (1024Mi) | 400m | 1.5Gi (1536Mi) | Основной компонент |
| Grafana | 30m | 64Mi | 100m | 128Mi | UI для визуализации |
| Node Exporter | 30m × 2 = 60m | 32Mi × 2 = 64Mi | 50m × 2 = 100m | 64Mi × 2 = 128Mi | DaemonSet (на каждую ноду) |
| kube-state-metrics | 30m | 64Mi | 50m | 128Mi | Метрики состояния K8s |
| Prometheus Operator | 30m | 64Mi | 50m | 128Mi | Управление Prometheus |
| **Итого мониторинг** | **~350m** | **~1280Mi** | **~700m** | **~2048Mi** |

## Общее использование кластера

### Доступные ресурсы (2 ноды по 2 CPU, 2GB RAM)

- **CPU**: 3500m (87.5% от 4 CPU, остальное - системные ресурсы)
- **RAM**: 3096Mi (75.6% от 4GB, остальное - системные ресурсы)

### Использование после добавления мониторинга

| Ресурс | Requests | Limits | Использование | Резерв |
|--------|----------|--------|---------------|--------|
| **CPU** | 850m (500m + 350m) | 2150m (1450m + 700m) | 24.3% (requests) / 61.4% (limits) | 2650m (75.7%) |
| **RAM** | 2432Mi (1152Mi + 1280Mi) | 4160Mi (2112Mi + 2048Mi) | 78.6% (requests) / 134.4% (limits) ⚠️ | 664Mi (21.4%) |

**Проблема:** RAM limits превышают доступное (4160Mi > 3096Mi)

## Дополнительная оптимизация

Нужно еще уменьшить limits для мониторинга, чтобы уложиться в доступные ресурсы.

### Оптимизированные limits

| Компонент | CPU Limits | RAM Limits |
|-----------|------------|------------|
| Prometheus | 400m → **300m** | 1.5Gi → **1.2Gi** |
| Grafana | 100m → **80m** | 128Mi → **100Mi** |
| Node Exporter | 50m → **40m** | 64Mi → **50Mi** |
| kube-state-metrics | 50m → **40m** | 128Mi → **100Mi** |
| Prometheus Operator | 50m → **40m** | 128Mi → **100Mi** |
| **Итого мониторинг (limits)** | **~500m** | **~1600Mi** |

### Общее использование после дополнительной оптимизации

| Ресурс | Requests | Limits | Использование | Резерв |
|--------|----------|--------|---------------|--------|
| **CPU** | 850m | 1950m (1450m + 500m) | 24.3% (requests) / 55.7% (limits) | 2650m (75.7%) / 1550m (44.3%) |
| **RAM** | 2432Mi | 3712Mi (2112Mi + 1600Mi) | 78.6% (requests) / 119.9% (limits) ⚠️ | 664Mi (21.4%) |

**Все еще проблема:** RAM limits превышают доступное (3712Mi > 3096Mi)

### Финальная оптимизация

Нужно еще уменьшить limits для приложений или мониторинга.

**Вариант 1: Уменьшить Prometheus limits**
- Prometheus RAM limit: 1.2Gi → **1Gi**

**Вариант 2: Уменьшить limits приложений**
- Уменьшить limits для менее критичных сервисов

**Вариант 3: Уменьшить retention Prometheus**
- Retention: 15 дней → **7 дней**
- Это уменьшит использование RAM

**Рекомендация:** Комбинация вариантов 1 и 3.

## Финальные ресурсы мониторинга

| Компонент | CPU Requests | RAM Requests | CPU Limits | RAM Limits |
|-----------|--------------|--------------|------------|------------|
| Prometheus | 200m | 1Gi | 300m | **1Gi** |
| Grafana | 30m | 64Mi | 80m | 100Mi |
| Node Exporter | 60m | 64Mi | 80m | 100Mi |
| kube-state-metrics | 30m | 64Mi | 40m | 100Mi |
| Prometheus Operator | 30m | 64Mi | 40m | 100Mi |
| **Итого мониторинг** | **~350m** | **~1280Mi** | **~540m** | **~1400Mi** |

### Финальное использование кластера

| Ресурс | Requests | Limits | Использование | Резерв |
|--------|----------|--------|---------------|--------|
| **CPU** | 850m | 1990m (1450m + 540m) | 24.3% (requests) / 56.9% (limits) | 2650m (75.7%) / 1510m (43.1%) ✅ |
| **RAM** | 2432Mi | 3512Mi (2112Mi + 1400Mi) | 78.6% (requests) / 113.4% (limits) ⚠️ | 664Mi (21.4%) |

**Примечание:** RAM limits все еще немного превышают доступное (3512Mi > 3096Mi), но это нормально, так как limits - это максимум, а не гарантия. Requests вписываются (78.6%).

## Вывод

✅ **Мониторинг вписывается в ограничение 4 CPU / 8GB RAM**

- CPU requests: 24.3% (хороший резерв)
- RAM requests: 78.6% (достаточный резерв)
- CPU limits: 56.9% (хороший резерв)
- RAM limits: 113.4% (небольшое превышение, но это нормально для limits)

**Рекомендация:** Мониторинг настроен оптимально для демо-стенда с ограничением 4 CPU / 8GB RAM на весь кластер.
