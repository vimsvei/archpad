# Настройка Force Push в GitLab для защищенных веток

## Проблема

GitLab по умолчанию защищает ветку `main` от force push. Это сделано для безопасности, но может мешать при необходимости перезаписать историю (например, после удаления чувствительных данных).

## Решение: Временное снятие защиты ветки

### Шаг 1: Снять защиту ветки в GitLab

1. Откройте GitLab проект: `https://gitlab.com/zs-archipad/archpad`
2. Перейдите в **Settings** → **Repository**
3. Раскройте раздел **Protected branches**
4. Найдите ветку `main` в списке защищенных веток
5. Нажмите **Unprotect** рядом с веткой `main`
6. Подтвердите снятие защиты

### Шаг 2: Выполнить Force Push

После снятия защиты выполните:

```bash
git push Aleksandr-Zelentsov main --force
```

### Шаг 3: Вернуть защиту ветки

**ВАЖНО:** После успешного push немедленно верните защиту ветки:

1. В GitLab снова перейдите в **Settings** → **Repository** → **Protected branches**
2. Найдите ветку `main` и нажмите **Protect**
3. Настройте защиту:
   - **Allowed to push**: выберите пользователей/роли, которым разрешен push
   - **Allowed to merge**: выберите пользователей/роли, которым разрешен merge
   - **Allowed to force push**: **Оставьте пустым** (никому не разрешайте force push)

## Альтернативный подход: Удаление через новый коммит

Если нельзя снять защиту или не хотите перезаписывать историю, можно создать новый коммит, который удаляет файлы:

```bash
# Удалить файлы из текущего состояния (если они еще не удалены)
git rm -r --cached infra/timeweb/k8s_config/twc-archpad-k8s-cluster-config.yaml

# Закоммитить удаление
git commit -m "chore: remove sensitive k8s config from repository"

# Обычный push (без force)
git push Aleksandr-Zelentsov main
```

**Примечание:** Файлы останутся в истории git, но будут удалены из текущего состояния репозитория и не попадут в будущие клоны.

## Почему Force Push был необходим?

После выполнения `git-filter-repo` или `git-filter-branch` для удаления файлов из всей истории:
- Все коммиты получают новые хеши
- Локальная история полностью отличается от удаленной
- Обычный push невозможен без force

## Безопасность после Force Push

После force push все разработчики должны пересинхронизировать репозитории:

```bash
git fetch Aleksandr-Zelentsov
git reset --hard Aleksandr-Zelentsov/main
```

**Предупреждение:** Это перезапишет все локальные изменения!
