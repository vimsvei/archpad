# Мониторинг Kubernetes кластера

## Обзор

Этот документ описывает различные решения для мониторинга Kubernetes кластера, их преимущества и недостатки.

## Краткий ответ: Kubernetes Dashboard vs Prometheus + Grafana

**Kubernetes Dashboard** - это **инструмент управления** кластером, а не мониторинга:
- ✅ Показывает текущее состояние ресурсов (поды, сервисы, deployments)
- ✅ Позволяет просматривать логи подов
- ❌ **НЕ хранит исторические данные** - только текущие значения
- ❌ **НЕТ алертов** - нет системы оповещений
- ❌ **НЕТ настраиваемых дашбордов** - фиксированный интерфейс
- ❌ **НЕТ метрик приложений** - только метрики Kubernetes объектов

**Prometheus + Grafana** - это **полноценный мониторинг**:
- ✅ **Исторические данные** - можно анализировать тренды за дни/недели/месяцы
- ✅ **Алерты** - настраиваемые оповещения о проблемах
- ✅ **Настраиваемые дашборды** - визуализация любых метрик
- ✅ **Метрики приложений** - не только Kubernetes, но и ваши сервисы
- ✅ **PromQL** - мощный язык запросов для анализа

**Вывод:** Kubernetes Dashboard можно использовать как **дополнение** для оперативного управления, но он **не заменяет** Prometheus + Grafana для полноценного мониторинга.

**У вас уже есть:** Prometheus + Grafana + Loki + Tempo настроены локально в `infra/monitoring/` - их можно перенести в Kubernetes.

## Текущее состояние

В проекте уже настроен локальный стек мониторинга для Docker Compose:

- **Grafana** - визуализация метрик, логов и трейсов
- **Prometheus** - сбор метрик
- **Loki** - централизованные логи
- **Tempo** - распределенный трейсинг
- **OpenTelemetry Collector** - сбор трейсов
- **Vector** - сбор логов из Docker контейнеров
- **Blackbox Exporter** - проверка доступности сервисов

**См. `infra/monitoring/README.md` для локальной настройки.**

## Решения для мониторинга Kubernetes

### 0. Kubernetes Dashboard (встроенный UI)

**Описание:** Встроенный веб-интерфейс для управления Kubernetes кластером. Предоставляет базовую информацию о ресурсах.

**Что умеет:**
- ✅ Просмотр подов, сервисов, deployments, configmaps, secrets
- ✅ Просмотр логов подов (в реальном времени)
- ✅ Описание ресурсов (YAML)
- ✅ Управление ресурсами (создание, удаление, редактирование)
- ✅ Базовые метрики использования CPU/памяти (текущие значения)

**Чего НЕ умеет:**
- ❌ **Долгосрочное хранение метрик** - показывает только текущие значения
- ❌ **Исторические данные** - нет истории использования ресурсов
- ❌ **Алерты** - нет системы оповещений
- ❌ **Настраиваемые дашборды** - фиксированный интерфейс
- ❌ **Сложные запросы** - нет PromQL или аналогов
- ❌ **Визуализация трендов** - нет графиков за период
- ❌ **Метрики приложений** - только метрики Kubernetes объектов
- ❌ **Централизованные логи** - только логи отдельных подов
- ❌ **Трейсинг** - нет распределенного трейсинга

**Когда использовать:**
- ✅ Для оперативного управления кластером (просмотр/редактирование ресурсов)
- ✅ Для быстрого просмотра логов подов
- ✅ Для базового понимания состояния кластера
- ❌ **НЕ подходит для полноценного мониторинга**

**Установка:**
```bash
# Через kubectl
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml

# Создать ServiceAccount и получить токен
kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard
kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin
kubectl -n kubernetes-dashboard create token dashboard-admin
```

**Ресурсы:**
- CPU: ~100m
- Memory: ~256Mi

**Рекомендация:** ⚠️ **Можно использовать как дополнение**, но **не заменяет** полноценный мониторинг (Prometheus + Grafana).

---

### 1. Prometheus + Grafana (Open Source)

**Описание:** Стандартное решение для мониторинга Kubernetes. Prometheus собирает метрики, Grafana визуализирует.

**Компоненты:**
- **Prometheus** - сбор и хранение метрик
- **Grafana** - визуализация и дашборды
- **Alertmanager** - управление алертами
- **Node Exporter** - метрики нод
- **kube-state-metrics** - метрики состояния Kubernetes объектов
- **cAdvisor** - метрики контейнеров (встроен в kubelet)

**Плюсы:**
- ✅ Бесплатно и open source
- ✅ Стандарт де-факто для Kubernetes
- ✅ Огромное сообщество и готовые дашборды
- ✅ Гибкая настройка и расширяемость
- ✅ Уже настроено локально (легко перенести в K8s)
- ✅ PromQL - мощный язык запросов
- ✅ Service Discovery для автоматического обнаружения подов
- ✅ Долгосрочное хранение через Thanos или Cortex

**Минусы:**
- ❌ Требует настройки и поддержки
- ❌ Нет встроенного сбора логов (нужен Loki или другой инструмент)
- ❌ Нет встроенного трейсинга (нужен Jaeger или Tempo)
- ❌ Масштабирование требует дополнительных компонентов (Thanos)
- ❌ Нет готовых алертов (нужно настраивать вручную)

**Рекомендация:** ✅ **Рекомендуется** для начала - уже есть локальная настройка, легко перенести в Kubernetes.

**Установка:**
```bash
# Через Helm
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring --create-namespace

# Или через ArgoCD Application (GitOps)
```

**Ресурсы:**
- CPU: ~500m (Prometheus), ~100m (Grafana)
- Memory: ~2Gi (Prometheus), ~256Mi (Grafana)
- Storage: зависит от retention (рекомендуется 15-30 дней)

---

### 2. Elastic Stack (ELK/EFK)

**Описание:** Open source стек для логов и метрик (Elasticsearch, Logstash/Fluentd, Kibana).

**Компоненты:**
- **Elasticsearch** - хранение и поиск
- **Logstash/Fluentd** - сбор и обработка логов
- **Kibana** - визуализация
- **Metricbeat** - сбор метрик

**Плюсы:**
- ✅ Бесплатно и open source
- ✅ Мощный поиск по логам
- ✅ Гибкая настройка
- ✅ Хорошо подходит для логов

**Минусы:**
- ❌ Требует много ресурсов (Elasticsearch)
- ❌ Сложная настройка
- ❌ Не очень хорошо для метрик (лучше Prometheus)
- ❌ Нет встроенного трейсинга

**Ресурсы:**
- CPU: ~2 cores (Elasticsearch)
- Memory: ~4Gi (Elasticsearch)
- Storage: зависит от retention

**Рекомендация:** ⚠️ Рассмотреть, если основная задача - работа с логами.

---

### 3. Jaeger (для трейсинга)

**Описание:** Open source решение для распределенного трейсинга.

**Плюсы:**
- ✅ Бесплатно и open source
- ✅ Стандарт для распределенного трейсинга
- ✅ Хорошая интеграция с OpenTelemetry
- ✅ Простая установка

**Минусы:**
- ❌ Только для трейсинга (нужны другие инструменты для метрик и логов)
- ❌ Требует настройки в приложениях

**Рекомендация:** ✅ Использовать вместе с Prometheus + Grafana для полного стека.

---

### 4. OpenTelemetry (стандарт)

**Описание:** Open standard для сбора телеметрии (метрики, логи, трейсы).

**Плюсы:**
- ✅ Единый стандарт для всех инструментов
- ✅ Vendor-agnostic
- ✅ Автоматическая инструментация
- ✅ Работает с любым бэкендом (Prometheus, Jaeger, Tempo и т.д.)

**Минусы:**
- ❌ Требует настройки в приложениях
- ❌ Нужен бэкенд для хранения данных

**Рекомендация:** ✅ Использовать для сбора данных, отправлять в Prometheus/Grafana.

---

## Рекомендации для вашего проекта

### Вариант 0: Kubernetes Dashboard (опционально, как дополнение)

**Когда использовать:**
- Для быстрого просмотра ресурсов кластера
- Для оперативного управления (редактирование YAML)
- Для просмотра логов подов в реальном времени

**Когда НЕ использовать:**
- ❌ Для мониторинга производительности
- ❌ Для анализа исторических данных
- ❌ Для настройки алертов
- ❌ Для визуализации метрик

**Вывод:** Kubernetes Dashboard - это **инструмент управления**, а не мониторинга. Можно установить как дополнение, но он **не заменяет** Prometheus + Grafana.

---

### Вариант 1: Prometheus + Grafana + Loki + Tempo (рекомендуется)

**Почему:**
- ✅ Уже настроено локально - легко перенести в Kubernetes
- ✅ Бесплатно и open source
- ✅ Полный стек: метрики, логи, трейсы
- ✅ Гибкая настройка
- ✅ Соответствует текущей архитектуре проекта
- ✅ **Исторические данные** - можно анализировать тренды
- ✅ **Алерты** - настраиваемые оповещения
- ✅ **Настраиваемые дашборды** - визуализация любых метрик
- ✅ **PromQL** - мощный язык запросов

**Компоненты:**
- **Prometheus** - метрики
- **Grafana** - визуализация
- **Loki** - логи
- **Tempo** - трейсы
- **OpenTelemetry Collector** - сбор данных

**Установка:**
```bash
# Через Helm
helm repo add grafana https://grafana.github.io/helm-charts
helm install loki grafana/loki-stack -n monitoring --create-namespace
helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring
helm install tempo grafana/tempo -n monitoring
```

**Ресурсы:**
- Prometheus: ~500m CPU, ~2Gi RAM
- Grafana: ~100m CPU, ~256Mi RAM
- Loki: ~200m CPU, ~512Mi RAM
- Tempo: ~200m CPU, ~512Mi RAM

### Вариант 2: Elastic Stack (ELK/EFK) - альтернатива для логов

**Когда использовать:**
- Основная задача - работа с логами
- Нужен мощный поиск по логам
- Готовы выделить больше ресурсов (Elasticsearch требует много памяти)

**Минусы:**
- ❌ Требует много ресурсов (Elasticsearch: ~2 CPU, ~4Gi RAM)
- ❌ Сложная настройка
- ❌ Не очень хорошо для метрик (лучше Prometheus)
- ❌ Нет встроенного трейсинга

**Рекомендация:** ⚠️ Рассмотреть только если основная задача - работа с логами, иначе лучше Prometheus + Grafana + Loki.

---

## Сравнительная таблица (только бесплатные решения)

| Решение | Сложность | Метрики | Логи | Трейсы | Исторические данные | Алерты | Рекомендация |
|---------|-----------|---------|------|--------|-------------------|--------|--------------|
| Kubernetes Dashboard | Низкая | ⚠️ Только текущие | ⚠️ Только поды | ❌ | ❌ | ❌ | ⚠️ Для управления |
| Prometheus + Grafana | Средняя | ✅ | ❌* | ❌* | ✅ | ✅ | ✅ Рекомендуется |
| Elastic Stack (ELK) | Высокая | ⚠️ | ✅ | ❌ | ✅ | ⚠️ | ⚠️ Для логов |
| Jaeger | Средняя | ❌ | ❌ | ✅ | ✅ | ❌ | ✅ С Prometheus |

*Требуются дополнительные компоненты (Loki для логов, Tempo/Jaeger для трейсов)

**Примечание:** Для полного стека рекомендуется комбинация:
- **Prometheus + Grafana** - метрики и визуализация
- **Loki** - логи (интегрируется с Grafana)
- **Tempo или Jaeger** - трейсы (интегрируется с Grafana)

---

## Что мониторить в Kubernetes

### Инфраструктура
- **Ноды**: CPU, память, диск, сеть
- **Поды**: CPU, память, рестарты
- **Deployments**: реплики, статус
- **Services**: доступность, latency

### Приложения
- **Метрики приложений**: запросы, ошибки, latency
- **Логи**: ошибки, важные события
- **Трейсы**: распределенные транзакции

### Kubernetes объекты
- **Pods**: статус, рестарты, ресурсы
- **Deployments**: реплики, обновления
- **Services**: endpoints, доступность
- **Ingress**: запросы, ошибки

---

## Проектирование для Kubernetes

Для развертывания Prometheus + Grafana в Kubernetes кластере Archpad создан отдельный документ с проектированием:

- **[MONITORING_DESIGN.md](./MONITORING_DESIGN.md)** - полное проектирование архитектуры мониторинга
- **[MONITORING_SECRETS.md](./MONITORING_SECRETS.md)** - список секретов, которые нужно создать в Vault

**Основные моменты:**
- Используется Prometheus Operator для автоматического Service Discovery
- Grafana развертывается отдельно с публичным доступом на `monitoring.archpad.pro`
- Все секреты хранятся в Vault
- Метрики БД кластера (192.168.0.4) собираются через статические targets
- Логи и трейсы не включаются (добавим позже)

## Следующие шаги

1. ✅ **Проектирование завершено** - см. [MONITORING_DESIGN.md](./MONITORING_DESIGN.md)
2. ⏳ **Создать секреты в Vault** - см. [MONITORING_SECRETS.md](./MONITORING_SECRETS.md)
3. ⏳ **Развернуть Prometheus** через ArgoCD
4. ⏳ **Развернуть Grafana** через ArgoCD
5. ⏳ **Настроить Service Discovery** для автоматического обнаружения подов
6. ⏳ **Проверить работу** мониторинга
7. ⏳ **Добавить Loki** для логов (позже)
8. ⏳ **Добавить Tempo** для трейсинга (позже)

## Дополнительные ресурсы

- [Prometheus Operator](https://github.com/prometheus-operator/prometheus-operator)
- [Grafana Kubernetes Dashboards](https://grafana.com/grafana/dashboards/)
- [kube-prometheus-stack](https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack)
- [OpenTelemetry](https://opentelemetry.io/)
