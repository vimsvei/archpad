# Мониторинг Kubernetes кластера

## Обзор

Этот документ описывает различные решения для мониторинга Kubernetes кластера, их преимущества и недостатки.

## Текущее состояние

В проекте уже настроен локальный стек мониторинга для Docker Compose:

- **Grafana** - визуализация метрик, логов и трейсов
- **Prometheus** - сбор метрик
- **Loki** - централизованные логи
- **Tempo** - распределенный трейсинг
- **OpenTelemetry Collector** - сбор трейсов
- **Vector** - сбор логов из Docker контейнеров
- **Blackbox Exporter** - проверка доступности сервисов

**См. `infra/monitoring/README.md` для локальной настройки.**

## Решения для мониторинга Kubernetes

### 1. Prometheus + Grafana (Open Source)

**Описание:** Стандартное решение для мониторинга Kubernetes. Prometheus собирает метрики, Grafana визуализирует.

**Компоненты:**
- **Prometheus** - сбор и хранение метрик
- **Grafana** - визуализация и дашборды
- **Alertmanager** - управление алертами
- **Node Exporter** - метрики нод
- **kube-state-metrics** - метрики состояния Kubernetes объектов
- **cAdvisor** - метрики контейнеров (встроен в kubelet)

**Плюсы:**
- ✅ Бесплатно и open source
- ✅ Стандарт де-факто для Kubernetes
- ✅ Огромное сообщество и готовые дашборды
- ✅ Гибкая настройка и расширяемость
- ✅ Уже настроено локально (легко перенести в K8s)
- ✅ PromQL - мощный язык запросов
- ✅ Service Discovery для автоматического обнаружения подов
- ✅ Долгосрочное хранение через Thanos или Cortex

**Минусы:**
- ❌ Требует настройки и поддержки
- ❌ Нет встроенного сбора логов (нужен Loki или другой инструмент)
- ❌ Нет встроенного трейсинга (нужен Jaeger или Tempo)
- ❌ Масштабирование требует дополнительных компонентов (Thanos)
- ❌ Нет готовых алертов (нужно настраивать вручную)

**Рекомендация:** ✅ **Рекомендуется** для начала - уже есть локальная настройка, легко перенести в Kubernetes.

**Установка:**
```bash
# Через Helm
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring --create-namespace

# Или через ArgoCD Application (GitOps)
```

**Ресурсы:**
- CPU: ~500m (Prometheus), ~100m (Grafana)
- Memory: ~2Gi (Prometheus), ~256Mi (Grafana)
- Storage: зависит от retention (рекомендуется 15-30 дней)

---

### 2. Grafana Cloud (Managed)

**Описание:** Управляемый сервис от Grafana Labs, включает Prometheus, Loki, Tempo.

**Плюсы:**
- ✅ Полностью управляемый сервис
- ✅ Включает метрики, логи и трейсы в одном месте
- ✅ Автоматическое масштабирование
- ✅ Готовые дашборды и алерты
- ✅ Бесплатный tier для небольших проектов
- ✅ Простая интеграция с Kubernetes

**Минусы:**
- ❌ Платно для production нагрузок
- ❌ Зависимость от внешнего сервиса
- ❌ Данные хранятся вне кластера
- ❌ Ограничения на бесплатном tier

**Стоимость:**
- Free tier: до 10k метрик, 50GB логов, 50GB трейсов
- Pro: от $49/месяц за пользователя

**Рекомендация:** ⚠️ Рассмотреть для production, если нет ресурсов на поддержку собственного стека.

---

### 3. Datadog

**Описание:** Коммерческое решение для мониторинга инфраструктуры и приложений.

**Плюсы:**
- ✅ Все в одном: метрики, логи, трейсы, APM
- ✅ Автоматическое обнаружение сервисов
- ✅ Готовые дашборды для Kubernetes
- ✅ Интеграции с множеством сервисов
- ✅ AI-powered алерты
- ✅ Простая установка (DaemonSet)

**Минусы:**
- ❌ Дорого ($15-23/месяц за хост)
- ❌ Данные хранятся вне кластера
- ❌ Может быть избыточно для небольших проектов
- ❌ Vendor lock-in

**Стоимость:**
- Infrastructure Monitoring: от $15/месяц за хост
- APM: от $31/месяц за хост
- Log Management: от $0.10/GB

**Рекомендация:** ⚠️ Рассмотреть для enterprise проектов с большим бюджетом.

---

### 4. New Relic

**Описание:** Коммерческое решение для мониторинга приложений и инфраструктуры.

**Плюсы:**
- ✅ Все в одном: метрики, логи, трейсы, APM
- ✅ Готовые дашборды
- ✅ AI-powered insights
- ✅ Простая установка

**Минусы:**
- ❌ Дорого (от $99/месяц)
- ❌ Данные хранятся вне кластера
- ❌ Vendor lock-in
- ❌ Может быть избыточно для небольших проектов

**Стоимость:**
- Full-Stack Observability: от $99/месяц

**Рекомендация:** ⚠️ Рассмотреть для enterprise проектов.

---

### 5. Dynatrace

**Описание:** Enterprise решение с AI-powered мониторингом.

**Плюсы:**
- ✅ Автоматическое обнаружение и мониторинг
- ✅ AI-powered root cause analysis
- ✅ Все в одном: метрики, логи, трейсы, APM
- ✅ Готовые дашборды

**Минусы:**
- ❌ Очень дорого (от $69/месяц за хост)
- ❌ Данные хранятся вне кластера
- ❌ Vendor lock-in
- ❌ Избыточно для небольших проектов

**Стоимость:**
- Infrastructure Monitoring: от $69/месяц за хост

**Рекомендация:** ❌ Только для крупных enterprise проектов.

---

### 6. Elastic Stack (ELK/EFK)

**Описание:** Open source стек для логов и метрик (Elasticsearch, Logstash/Fluentd, Kibana).

**Компоненты:**
- **Elasticsearch** - хранение и поиск
- **Logstash/Fluentd** - сбор и обработка логов
- **Kibana** - визуализация
- **Metricbeat** - сбор метрик

**Плюсы:**
- ✅ Бесплатно и open source
- ✅ Мощный поиск по логам
- ✅ Гибкая настройка
- ✅ Хорошо подходит для логов

**Минусы:**
- ❌ Требует много ресурсов (Elasticsearch)
- ❌ Сложная настройка
- ❌ Не очень хорошо для метрик (лучше Prometheus)
- ❌ Нет встроенного трейсинга

**Ресурсы:**
- CPU: ~2 cores (Elasticsearch)
- Memory: ~4Gi (Elasticsearch)
- Storage: зависит от retention

**Рекомендация:** ⚠️ Рассмотреть, если основная задача - работа с логами.

---

### 7. Jaeger (для трейсинга)

**Описание:** Open source решение для распределенного трейсинга.

**Плюсы:**
- ✅ Бесплатно и open source
- ✅ Стандарт для распределенного трейсинга
- ✅ Хорошая интеграция с OpenTelemetry
- ✅ Простая установка

**Минусы:**
- ❌ Только для трейсинга (нужны другие инструменты для метрик и логов)
- ❌ Требует настройки в приложениях

**Рекомендация:** ✅ Использовать вместе с Prometheus + Grafana для полного стека.

---

### 8. OpenTelemetry (стандарт)

**Описание:** Open standard для сбора телеметрии (метрики, логи, трейсы).

**Плюсы:**
- ✅ Единый стандарт для всех инструментов
- ✅ Vendor-agnostic
- ✅ Автоматическая инструментация
- ✅ Работает с любым бэкендом (Prometheus, Jaeger, Tempo и т.д.)

**Минусы:**
- ❌ Требует настройки в приложениях
- ❌ Нужен бэкенд для хранения данных

**Рекомендация:** ✅ Использовать для сбора данных, отправлять в Prometheus/Grafana.

---

## Рекомендации для вашего проекта

### Вариант 1: Prometheus + Grafana + Loki + Tempo (рекомендуется)

**Почему:**
- ✅ Уже настроено локально - легко перенести в Kubernetes
- ✅ Бесплатно и open source
- ✅ Полный стек: метрики, логи, трейсы
- ✅ Гибкая настройка
- ✅ Соответствует текущей архитектуре проекта

**Компоненты:**
- **Prometheus** - метрики
- **Grafana** - визуализация
- **Loki** - логи
- **Tempo** - трейсы
- **OpenTelemetry Collector** - сбор данных

**Установка:**
```bash
# Через Helm
helm repo add grafana https://grafana.github.io/helm-charts
helm install loki grafana/loki-stack -n monitoring --create-namespace
helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring
helm install tempo grafana/tempo -n monitoring
```

**Ресурсы:**
- Prometheus: ~500m CPU, ~2Gi RAM
- Grafana: ~100m CPU, ~256Mi RAM
- Loki: ~200m CPU, ~512Mi RAM
- Tempo: ~200m CPU, ~512Mi RAM

### Вариант 2: Grafana Cloud (если нет ресурсов на поддержку)

**Почему:**
- ✅ Управляемый сервис
- ✅ Все в одном месте
- ✅ Бесплатный tier для начала

**Минусы:**
- ❌ Платно для production
- ❌ Данные вне кластера

### Вариант 3: Коммерческие решения (для enterprise)

**Когда использовать:**
- Большой бюджет
- Нет ресурсов на поддержку собственного стека
- Нужны готовые решения из коробки

---

## Сравнительная таблица

| Решение | Стоимость | Сложность | Метрики | Логи | Трейсы | Рекомендация |
|---------|-----------|-----------|---------|------|--------|--------------|
| Prometheus + Grafana | Бесплатно | Средняя | ✅ | ❌* | ❌* | ✅ Рекомендуется |
| Grafana Cloud | Платно | Низкая | ✅ | ✅ | ✅ | ⚠️ Для production |
| Datadog | Дорого | Низкая | ✅ | ✅ | ✅ | ⚠️ Enterprise |
| New Relic | Дорого | Низкая | ✅ | ✅ | ✅ | ⚠️ Enterprise |
| Elastic Stack | Бесплатно | Высокая | ⚠️ | ✅ | ❌ | ⚠️ Для логов |
| Jaeger | Бесплатно | Средняя | ❌ | ❌ | ✅ | ✅ С Prometheus |

*Требуются дополнительные компоненты (Loki для логов, Tempo/Jaeger для трейсов)

---

## Что мониторить в Kubernetes

### Инфраструктура
- **Ноды**: CPU, память, диск, сеть
- **Поды**: CPU, память, рестарты
- **Deployments**: реплики, статус
- **Services**: доступность, latency

### Приложения
- **Метрики приложений**: запросы, ошибки, latency
- **Логи**: ошибки, важные события
- **Трейсы**: распределенные транзакции

### Kubernetes объекты
- **Pods**: статус, рестарты, ресурсы
- **Deployments**: реплики, обновления
- **Services**: endpoints, доступность
- **Ingress**: запросы, ошибки

---

## Следующие шаги

1. **Выбрать решение** на основе бюджета и требований
2. **Развернуть в Kubernetes** через Helm или ArgoCD
3. **Настроить Service Discovery** для автоматического обнаружения подов
4. **Создать дашборды** для важных метрик
5. **Настроить алерты** для критичных событий

## Дополнительные ресурсы

- [Prometheus Operator](https://github.com/prometheus-operator/prometheus-operator)
- [Grafana Kubernetes Dashboards](https://grafana.com/grafana/dashboards/)
- [kube-prometheus-stack](https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack)
- [OpenTelemetry](https://opentelemetry.io/)
