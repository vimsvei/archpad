# Расчет ресурсов для кластера

## Единицы измерения

- **CPU**: измеряется в миллиCPU (m) или cores
  - `1000m = 1 core = 1 CPU`
  - `250m = 0.25 core = 1/4 ядра`
  - `100m = 0.1 core = 1/10 ядра`
  
- **RAM**: измеряется в мегабайтах (Mi) или гигабайтах (Gi)
  - `1024Mi = 1Gi = 1GB`
  - `500Mi = ~0.5GB`
  - `128Mi = ~0.125GB`

**Пример:** `250m CPU, 500Mi RAM` означает:
- 0.25 ядра CPU (четверть ядра)
- 500 мегабайт оперативной памяти (~0.5GB)

## Текущая конфигурация

### Вариант 1: 6 нод по 1 CPU, 2GB RAM (текущая)

**Всего ресурсов:**
- CPU: 6 cores (6000m)
- RAM: 12GB (12288Mi)

**Системные ресурсы (на каждую ноду):**
- Kubernetes system pods (kubelet, kube-proxy): ~100m CPU, ~200Mi RAM
- Vault Agent Injector: ~50m CPU, ~100Mi RAM
- Traefik: ~50m CPU, ~100Mi RAM
- ArgoCD: ~50m CPU, ~100Mi RAM

**Итого системных ресурсов:**
- На ноду: ~250m CPU, ~500Mi RAM
- Всего (6 нод): ~1500m CPU, ~3000Mi RAM

**Доступно для приложений:**
- CPU: 4500m (75% от общего)
- RAM: 9216Mi (75% от общего)

### Вариант 2: 2 ноды по 2 CPU, 2GB RAM (предлагаемая)

**Всего ресурсов:**
- CPU: 4 cores (4000m)
- RAM: 4GB (4096Mi)

**Системные ресурсы:**
- На ноду: ~250m CPU, ~500Mi RAM
- Всего (2 ноды): ~500m CPU, ~1000Mi RAM

**Доступно для приложений:**
- CPU: 3500m (87.5% от общего)
- RAM: 3096Mi (75.6% от общего)

## Ресурсы приложений (requests) - ОПТИМИЗИРОВАНО ДЛЯ ДЕМО-СТЕНДА

| Сервис | CPU Requests | Memory Requests | Replicas | Итого CPU | Итого RAM |
|--------|--------------|-----------------|----------|-----------|-----------|
| **Backend Services** |
| arch-repo-service | 30m | 64Mi | 1 | 30m | 64Mi |
| tenant-service | 30m | 64Mi | 1 | 30m | 64Mi |
| hasura-sync-service (Job) | 30m | 64Mi | 1* | 30m | 64Mi |
| registry-secret-sync (Job) | 30m | 64Mi | 1* | 30m | 64Mi |
| **Frontend** |
| portal | 50m | 128Mi | 1 | 50m | 128Mi |
| **Инфраструктура** |
| hasura | 50m | 128Mi | 1 | 50m | 128Mi |
| tolgee | 100m | 256Mi | 1 | 100m | 256Mi |
| mailpit | 30m | 64Mi | 1 | 30m | 64Mi |
| **Безопасность (Ory)** |
| kratos | 30m | 64Mi | 1 | 30m | 64Mi |
| hydra | 30m | 64Mi | 1 | 30m | 64Mi |
| oathkeeper | 30m | 64Mi | 1 | 30m | 64Mi |
| **Утилиты** |
| argocd-image-updater | 50m | 64Mi | 1 | 50m | 64Mi |
| pgadmin | 50m | 128Mi | 1 | 50m | 128Mi |
| **Итого requests** | | | | **~500m** | **~1152Mi** |

*Jobs запускаются периодически, не всегда работают

## Ресурсы приложений (limits) - ОПТИМИЗИРОВАНО ДЛЯ ДЕМО-СТЕНДА

| Сервис | CPU Limits | Memory Limits | Итого CPU | Итого RAM |
|--------|------------|---------------|-----------|-----------|
| arch-repo-service | 100m | 128Mi | 100m | 128Mi |
| tenant-service | 100m | 128Mi | 100m | 128Mi |
| portal | 150m | 256Mi | 150m | 256Mi |
| hasura | 150m | 256Mi | 150m | 256Mi |
| tolgee | 200m | 384Mi | 200m | 384Mi |
| mailpit | 100m | 128Mi | 100m | 128Mi |
| argocd-image-updater | 200m | 256Mi | 200m | 256Mi |
| pgadmin | 200m | 256Mi | 200m | 256Mi |
| kratos | 100m | 128Mi | 100m | 128Mi |
| hydra | 100m | 128Mi | 100m | 128Mi |
| oathkeeper | 100m | 128Mi | 100m | 128Mi |
| **Итого limits** | | | **~1450m** | **~2112Mi** |

## Сравнение вариантов

### Вариант 1: 6 нод (1 CPU, 2GB RAM каждая)

**Доступно для приложений:**
- CPU: 4500m
- RAM: 9216Mi

**Использование:**
- CPU requests: ~620m (13.8% от доступного)
- RAM requests: ~1504Mi (16.3% от доступного)
- CPU limits: ~3350m (74.4% от доступного)
- RAM limits: ~3008Mi (32.6% от доступного)

**Резерв:**
- CPU: 1150m (25.6%)
- RAM: 6208Mi (67.4%)

### Вариант 2: 2 ноды (2 CPU, 2GB RAM каждая) - ОПТИМИЗИРОВАНО

**Доступно для приложений:**
- CPU: 3500m
- RAM: 3096Mi

**Использование (после оптимизации):**
- CPU requests: ~500m (14.3% от доступного) ✅
- RAM requests: ~1152Mi (37.2% от доступного) ✅
- CPU limits: ~1450m (41.4% от доступного) ✅
- RAM limits: ~2112Mi (68.2% от доступного) ✅

**Резерв:**
- CPU: 2050m (58.6%) ✅ **ОТЛИЧНО**
- RAM: 984Mi (31.8%) ✅ **ДОСТАТОЧНО**

## Выводы и рекомендации - ОПТИМИЗИРОВАНО ДЛЯ ДЕМО-СТЕНДА

### ✅ **2 ноды по 2 CPU, 2GB RAM - ДОСТАТОЧНО (после оптимизации)**

**После оптимизации ресурсов:**
1. ✅ **RAM limits используются на 68%** - хороший резерв (32%)
2. ✅ **CPU limits используются на 41%** - отличный резерв (59%)
3. ✅ **Есть место для масштабирования** - можно увеличить количество реплик при необходимости
4. ✅ **Низкий риск OOM** - достаточный резерв памяти
5. ✅ **Ory компоненты имеют resources** - все компоненты ограничены

### ✅ **Рекомендации:**

#### Вариант A: Оставить 4 ноды (1 CPU, 2GB RAM каждая)

**Доступно для приложений:**
- CPU: 3000m
- RAM: 6144Mi

**Использование:**
- CPU requests: ~620m (20.7%)
- RAM requests: ~1504Mi (24.5%)
- CPU limits: ~3350m (111.7%) ⚠️ **Превышает доступное!**
- RAM limits: ~3008Mi (49.0%)

**Проблема:** CPU limits превышают доступное, но это нормально, так как limits - это максимум, а не гарантия.

**Резерв:**
- CPU: достаточно для requests
- RAM: 3136Mi (51%)

**Вывод:** ✅ **Достаточно для текущей нагрузки**, но нет большого резерва для масштабирования.

#### Вариант B: 2 ноды по 2 CPU, 4GB RAM каждая (рекомендуется)

**Доступно для приложений:**
- CPU: 3500m
- RAM: 6144Mi (2 ноды × 4GB - системные ресурсы)

**Использование:**
- CPU requests: ~620m (17.7%)
- RAM requests: ~1504Mi (24.5%)
- CPU limits: ~3350m (95.7%)
- RAM limits: ~3008Mi (49.0%)

**Резерв:**
- CPU: 150m (4.3%) - мало, но достаточно для requests
- RAM: 3136Mi (51%) - хороший резерв

**Вывод:** ✅ **Достаточно** для текущей нагрузки с хорошим резервом RAM.

#### Вариант C: 3 ноды по 2 CPU, 2GB RAM каждая

**Доступно для приложений:**
- CPU: 5250m (3 ноды × 2 CPU - системные ресурсы)
- RAM: 4608Mi (3 ноды × 2GB - системные ресурсы)

**Использование:**
- CPU requests: ~620m (11.8%)
- RAM requests: ~1504Mi (32.6%)
- CPU limits: ~3350m (63.8%)
- RAM limits: ~3008Mi (65.3%)

**Резерв:**
- CPU: 1900m (36.2%) - хороший резерв
- RAM: 1600Mi (34.7%) - хороший резерв

**Вывод:** ✅ **Оптимально** - хороший баланс между стоимостью и резервом.

## Что было сделано для оптимизации

### 1. ✅ Добавлены resources для Ory компонентов

Ory компоненты (kratos, hydra, oathkeeper) теперь имеют ограничения ресурсов:

```yaml
# В kratos.deployment.yaml, hydra.deployment.yaml, oathkeeper.deployment.yaml
resources:
  requests:
    cpu: 30m
    memory: 64Mi
  limits:
    cpu: 100m
    memory: 128Mi
```

### 2. ✅ Уменьшены limits для всех сервисов

Все limits уменьшены в 2-3 раза для демо-стенда:
- Backend сервисы: 150m → 100m CPU
- Portal/Hasura: 300m → 150m CPU
- Tolgee: 500m → 200m CPU
- ArgoCD Image Updater: 500m → 200m CPU
- PgAdmin: 500m → 200m CPU

### 3. Проверить фактическое использование после применения изменений

```bash
# Проверить использование ресурсов
kubectl top nodes
kubectl top pods -A

# Проверить запрошенные ресурсы
kubectl describe nodes | grep -A 10 "Allocated resources"
```

### 4. Мониторинг после удаления нод

1. После применения изменений через ArgoCD подождать синхронизацию
2. Проверить, что все поды запустились
3. Мониторить 1-2 дня на стабильность
4. Убедиться, что нет проблем с памятью или CPU

## Итоговая рекомендация - ОПТИМИЗИРОВАНО ДЛЯ ДЕМО-СТЕНДА

### ✅ **РЕКОМЕНДУЕТСЯ:** 2 ноды по 2 CPU, 2GB RAM каждая (после оптимизации)
- ✅ Достаточно RAM (68% использования limits, 32% резерв)
- ✅ Отличный резерв CPU (41% использования limits, 59% резерв)
- ✅ Все компоненты имеют ограничения ресурсов
- ✅ Оптимальное соотношение цена/производительность для демо-стенда
- ✅ Соответствует использованию в Docker (8GB RAM, 3 CPU)

### ✅ **Альтернатива:** 3 ноды по 2 CPU, 2GB RAM каждая
- Еще больше резерва (если планируется масштабирование)
- Немного дороже

### ⚠️ **Минимум:** 4 ноды по 1 CPU, 2GB RAM каждая
- Текущая конфигурация
- Избыточно для демо-стенда после оптимизации

## Дополнительные соображения

1. **Vault, Traefik, ArgoCD** - системные компоненты, их ресурсы не учтены в расчетах выше (уже включены в системные ресурсы)

2. **Мониторинг** - если планируете развернуть Prometheus + Grafana, нужно добавить:
   - Prometheus: ~500m CPU, ~2Gi RAM
   - Grafana: ~100m CPU, ~256Mi RAM
   - Loki: ~200m CPU, ~512Mi RAM
   - Tempo: ~200m CPU, ~512Mi RAM
   - **Итого:** ~1000m CPU, ~3.3Gi RAM

3. **Резерв для пиковых нагрузок** - рекомендуется оставлять минимум 20% свободных ресурсов

4. **Неравномерное распределение** - поды могут распределяться неравномерно по нодам, нужен резерв на каждой ноде
